"bind"in Function.prototype||(Function.prototype.bind=function(a){var b=this;if(arguments.length<=1)return function(){return b.apply(a,arguments)};var c=Array.prototype.slice.call(arguments,1);return function(){return b.apply(a,arguments.length===0?c:c.concat(Array.prototype.slice.call(arguments)))}}),"trim"in String.prototype||(String.prototype.trim=function(){return this.replace(/^\s+/,"").replace(/\s+$/,"")}),"indexOf"in Array.prototype||(Array.prototype.indexOf=function(a,b){b===undefined&&(b=0),b<0&&(b+=this.length),b<0&&(b=0);for(var c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1}),"lastIndexOf"in Array.prototype||(Array.prototype.lastIndexOf=function(a,b){b===undefined&&(b=this.length-1),b<0&&(b+=this.length),b>this.length-1&&(b=this.length-1);for(b++;b-->0;)if(b in this&&this[b]===a)return b;return-1}),"forEach"in Array.prototype||(Array.prototype.forEach=function(a,b){for(var c=0,d=this.length;c<d;c++)c in this&&a.call(b,this[c],c,this)}),"map"in Array.prototype||(Array.prototype.map=function(a,b){var c=new Array(this.length);for(var d=0,e=this.length;d<e;d++)d in this&&(c[d]=a.call(b,this[d],d,this));return c}),"filter"in Array.prototype||(Array.prototype.filter=function(a,b){var c=[],d;for(var e=0,f=this.length;e<f;e++)e in this&&a.call(b,d=this[e],e,this)&&c.push(d);return c}),"every"in Array.prototype||(Array.prototype.every=function(a,b){for(var c=0,d=this.length;c<d;c++)if(c in this&&!a.call(b,this[c],c,this))return!1;return!0}),"some"in Array.prototype||(Array.prototype.some=function(a,b){for(var c=0,d=this.length;c<d;c++)if(c in this&&a.call(b,this[c],c,this))return!0;return!1}),Array.prototype.reduce||(Array.prototype.reduce=function(a){var b=this.length;if(typeof a!="function")throw new TypeError;if(b==0&&arguments.length==1)throw new TypeError;var c=0;if(arguments.length>=2)var d=arguments[1];else do{if(c in this){d=this[c++];break}if(++c>=b)throw new TypeError}while(!0);for(;c<b;c++)c in this&&(d=a.call(null,d,this[c],c,this));return d}),define("deep/ie-hacks",function(){});if(typeof define!="function")var define=require("amdefine")(module);define("deep/deep-collider",["require"],function(b){var c=function(){};return c.prototype={},{Collider:c,wrap:function(a,b){var c=function(c,d,e){return a(b(c,d,e),d,e)};return c._deep_collider=!0,c},copyTo:function(a,b){var c=function(c,d,e){return utils.setValueByPath(a,b,c),c};return c._deep_collider=!0,c},around:function(a){return a._deep_collider=!0,a},replace:function(a){var b=function(b){return a};return b._deep_collider=!0,b},log:function(){var a=function(a){return console.log("LayerTools : log : ",a),a};return a._deep_collider=!0,a},validate:function(b){return function(a){this._deep_collider=!0;if(!validator.isValid(a,b))throw new ValidationError(validator.report);return a}},remove:function(){var a=function(a,b,c){return delete b[c],undefined};return a._deep_colliderRemove=!0,a},assert:{isTrue:function(){return function(a){return console.assert(a===!0),a}},isFalse:function(){var a=function(a){return console.assert(a===!1),a};return a._deep_collider=!0,a},equal:function(a){return function(b){return this._deep_collider=!0,b==a}},notEqual:function(a){return function(b){return this._deep_collider=!0,b!=a}},isNumber:function(){return function(a){}},isBoolean:function(){return function(a){return this._deep_collider=!0,Math.abs(a)}},isFloat:function(){return function(a){}},isInteger:function(){return function(a){}},isString:function(){return function(a){}},isFunction:function(){return function(a){}},isArray:function(){return function(a){}},isObject:function(){return function(a){}},isPresentInArray:function(a){},isRetrievable:function(){}},array:{median:function(a){return function(a){this._deep_collider=!0}},mean:function(a){return function(a){this._deep_collider=!0}},reverse:function(){return function(a){return this._deep_collider=!0,typeof a.push=="function"?a.reverse():a}},sort:function(a){return function(a){this._deep_collider=!0}},filter:function(a){return function(a){this._deep_collider=!0}},merge:function(a,b){return function(a){this._deep_collider=!0}},remove:function(a){var b=function(b,c,d){if(b&&b.forEach)for(var e=0;e<b.length;e++)if(b[e]==a){b=b.slice(e,e+1);break}c[d]=b};return b._deep_collider=!0,b},push:function(a){return function(b){return a}},unshift:function(a){return function(b){return a}},pushTo:function(a,b){return function(c){return this._deep_collider=!0,utils.setValueByPath(a,b,c),c}},unshiftTo:function(a,b){return function(c){return this._deep_collider=!0,utils.setValueByPath(a,b,c),c}}},string:{injectedAs:function(a,b){},inject:function(a){},injectTo:function(a,b){return function(a){this._deep_collider=!0}},injectController:function(){return function(a,b){this._deep_collider=!0}},injectValueAs:function(a,b){},replace:function(a){return function(){return this._deep_collider=!0,a}},reverse:function(a){return function(a){this._deep_collideréds=!0}},prepend:function(a){var b=function(b,c,d){return a+b+""};return b._deep_collider=!0,b},append:function(a){var b=function(b,c,d){return b+a+""};return b._deep_collider=!0,b},split:function(a){return function(a){this._deep_collider=!0}}},number:{increment:function(a){return function(a){return this._deep_collider=!0,a+1}},decrement:function(a){return function(a){return this._deep_collider=!0,a-1}},add:function(a){return function(b){return this._deep_collider=!0,b+a}},substract:function(a){return function(b){return this._deep_collider=!0,b-a}},substractedOf:function(a){return function(b){return this._deep_collider=!0,a-b}},abs:function(){return function(a){return this._deep_collider=!0,Math.abs(a)}},multiply:function(a){return function(b){return this._deep_collider=!0,a*b}},divid:function(a){return function(b){return this._deep_collider=!0,a/b}},dividedBy:function(a){return function(b){return this._deep_collider=!0,b/a}},replace:function(a){return function(b){return this.__leafControllerTools=!0,a}},max:function(a){return function(b){return this._deep_collider=!0,Math.max(b,a)}},min:function(a){return function(a){return this._deep_collider=!0,Math.min(a,min)}}},object:{merge:function(b,c,d){var e=function(a){return deepCopy(b,a,c,d)};return e._deep_collider=!0,e},replace:function(a){var b=function(){return a};return b._deep_collider=!0,b},swapProperty:function(a,b){},insertPropertyBefore:function(a,b){},insertAfter:function(a,b){},prepend:function(a){},appendProperty:function(a,b){var c=function(c,d,e){return c[a]=b,c};return c._deep_collider=!0,c}},"boolean":{and:function(a){},or:function(a){}},func:{apply:function(a,b){return function(c){return b=b||null,this._deep_collider=!0,c.apply(a,b)}}}}}),{define:typeof define!="undefined"?define:function(a,b){module.exports=b(exports)}}.define("rql/parser",["exports"],function(a){function c(c,e){function j(b){f.args.push(b),f=b,a.lastSeen.indexOf(f.name)>=0&&(g.cache[f.name]=f.args)}function k(a){if(!f.name)f.name=a;else if(f.name!==a)throw new Error("Can not mix conjunctions within a group, use paranthesis around each set of same conjuctions (& and |)")}function l(a){return a&&a.args&&(delete a.parent,a.args.forEach(l)),a}if(typeof c=="undefined"||c===null)c="";var f=new a.Query,g=f;g.cache={};if(typeof c=="object"){if(c instanceof a.Query)return c;for(var h in c){var f=new a.Query;g.args.push(f),f.name="eq",f.args=[h,c[h]]}return g}if(c.charAt(0)=="?")throw new URIError("Query must not start with ?");a.jsonQueryCompatible&&(c=c.replace(/%3C=/g,"=le=").replace(/%3E=/g,"=ge=").replace(/%3C/g,"=lt=").replace(/%3E/g,"=gt=")),c.indexOf("/")>-1&&(c=c.replace(/[\+\*\$\-:\w%\._]*\/[\+\*\$\-:\w%\._\/]*/g,function(a){return"("+a.replace(/\//g,",")+")"})),c=c.replace(/(\([\+\*\$\-:\w%\._,]+\)|[\+\*\$\-:\w%\._]*|)([<>!]?=(?:[\w]*=)?|>|<)(\([\+\*\$\-:\w%\._,]+\)|[\+\*\$\-:\w%\._]*|)/g,function(a,c,d,e){if(d.length<3){if(!b[d])throw new URIError("Illegal operator "+d);d=b[d]}else d=d.substring(1,d.length-1);return d+"("+c+","+e+")"}),c.charAt(0)=="?"&&(c=c.substring(1));var i=c.replace(/(\))|([&\|,])?([\+\*\$\-:\w%\._]*)(\(?)/g,function(b,c,h,i,l){h&&(h==="&"&&k("and"),h==="|"&&k("or"));if(l){var m=new a.Query;m.name=i,m.parent=f,j(m)}else if(c){var n=!f.name;f=f.parent;if(!f)throw new URIError("Closing paranthesis without an opening paranthesis");n&&f.args.push(f.args.pop().args)}else if(i||h===","){f.args.push(d(i,e)),a.lastSeen.indexOf(f.name)>=0&&(g.cache[f.name]=f.args);if(f.name==="eq"&&f.args[0]===a.primaryKeyName){var o=f.args[1];o&&!(o instanceof RegExp)&&(o=o.toString()),g.cache[a.primaryKeyName]=o}}return""});if(f.parent)throw new URIError("Opening paranthesis without a closing paranthesis");if(i)throw new URIError("Illegal character in query string encountered "+i);return l(g),g}function d(b,c){var d=a.converters["default"];if(b.charAt(0)==="$"){var e=parseInt(b.substring(1))-1;return e>=0&&c?c[e]:undefined}if(b.indexOf(":")>-1){var f=b.split(":",2);d=a.converters[f[0]];if(!d)throw new URIError("Unknown converter "+f[0]);b=f[1]}return d(b)}var b={"=":"eq","==":"eq",">":"gt",">=":"ge","<":"lt","<=":"le","!=":"ne"};a.primaryKeyName="id",a.lastSeen=["sort","select","values","limit"],a.jsonQueryCompatible=!0,a.parse=a.parseQuery=c,a.parseGently=function(){var b;try{b=c.apply(this,arguments)}catch(d){b=new a.Query,b.error=d.message}return b},a.commonOperatorMap={and:"&",or:"|",eq:"=",ne:"!=",le:"<=",ge:">=",lt:"<",gt:">"};var e=a.autoConverted={"true":!0,"false":!1,"null":null,"undefined":undefined,Infinity:Infinity,"-Infinity":-Infinity};return a.converters={auto:function(b){if(e.hasOwnProperty(b))return e[b];var c=+b;if(isNaN(c)||c.toString()!==b)return b=decodeURIComponent(b),a.jsonQueryCompatible&&b.charAt(0)=="'"&&b.charAt(b.length-1)=="'"?JSON.parse('"'+b.substring(1,b.length-1)+'"'):b;return c},number:function(a){var b=+a;if(isNaN(b))throw new URIError("Invalid number "+b);return b},epoch:function(a){var b=new Date(+a);if(isNaN(b.getTime()))throw new URIError("Invalid date "+a);return b},isodate:function(b){var c="0000".substr(0,4-b.length)+b;return c+="0000-01-01T00:00:00Z".substring(c.length),a.converters.date(c)},date:function(a){var b=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*)?)Z$/.exec(a);b?date=new Date(Date.UTC(+b[1],+b[2]-1,+b[3],+b[4],+b[5],+b[6])):date=new Date(a);if(isNaN(date.getTime()))throw new URIError("Invalid date "+a);return date},"boolean":function(a){return a==="true"},string:function(a){return decodeURIComponent(a)},re:function(a){return new RegExp(decodeURIComponent(a),"i")},RE:function(a){return new RegExp(decodeURIComponent(a))},glob:function(a){var b=decodeURIComponent(a).replace(/([\\|\||\(|\)|\[|\{|\^|\$|\*|\+|\?|\.|\<|\>])/g,function(a){return"\\"+a}).replace(/\\\*/g,".*").replace(/\\\?/g,".?");return b.substring(0,2)!==".*"?b="^"+b:b=b.substring(2),b.substring(b.length-2)!==".*"?b+="$":b=b.substring(0,b.length-2),new RegExp(b,"i")}},a.converters["default"]=a.converters.auto,a.Query=function(){this.name="and",this.args=[]},a}),define("deep/promise",["require"],function(a){var b={},c=b.Deferred=function(){return typeof window!="undefined"?$.Deferred():new ioDeferred},d=b.when=function(a){return typeof window!="undefined"?$.when(a):ioWhen(a)},e=b.promise=function(a){return typeof window!="undefined"?a.promise():a.promise},f=b.all=function(a){if(a.length==0)return d([]);var b=c(),f=a.length,g=0,h=-1,i=[];return a.forEach(function(a){var c=h+1;d(a).then(function(a){i[c]=a,g++,g==f&&b.resolve(i)},function(a){b.reject(a)}),h++}),e(b)};return b});if(typeof define!="function")var define=require("amdefine")(module);define("deep/deep-compose",["require","exports","module","./promise"],function(a,b,c){function f(a,b){return function(){var c=this,e=arguments,f=d.Deferred(),g=a.apply(this,e);if(typeof g=="undefined"){g=b.apply(c,e);if(typeof g=="undefined")return g;if(!g.then)return g;d.when(g).then(function(a){f.resolve(a)},function(a){f.reject(a)})}else if(!g.then){g=b.apply(c,[g]);if(typeof g=="undefined")return g;if(!g.then)return g;d.when(g).then(function(a){f.resolve(a)},function(a){f.reject(a)})}else d.when(g).then(function(a){var g=e;typeof a!="undefined"&&(g=[a]),a=b.apply(c,g);if(typeof a=="undefined")return f.resolve(a);if(!a.then)return f.resolve(a);d.when(a).then(function(a){f.resolve(a)},function(a){f.reject(a)})},function(a){f.reject(a)});return d.promise(f)}}var d=a("./promise"),e=function(a){this.stack=a||[]};e.prototype={around:function(a){var b=function(b){return a(b)};return this.stack.push(b),this},after:function(a){var b=function(b){return f(b,a)};return this.stack.push(b),this},fail:function(a){var b=function(b){return function(){var c=this,e=arguments;return d.when(b.apply(this,e)).done(function(b){return b instanceof Error?a.apply(c,e):b}).fail(function(b){return a.apply(c,e)})}};return this.stack.push(b),this},before:function(a){var b=function(b){return f(a,b)};return this.stack.push(b),this},replace:function(a){var b=function(b){return a};return this.stack.push(b),this},parallele:function(a){var b=function(b){return function(){var c=arguments,e=[a.apply(this,c),b.apply(this,c)];return d.all(e)}};return this.stack.push(b),this}};var g=function(a){a=a||new e;var b=function(){if(!a.createIfNecessary)throw new Error("Decorator not applied ! (start)");return h.wrap(function(){},a).apply(this,arguments)};return b.decorator=a,b.after=function(c){return a.after(c),b},b.before=function(c){return a.before(c),b},b.fail=function(c){return a.fail(c),b},b.around=function(c){return a.around(c),b},b.parallele=function(c){return a.parallele(c),b},b.replace=function(c){return a.replace(c),b},b.createIfNecessary=function(a){return b.decorator.createIfNecessary=typeof a=="undefined"?!0:a,b},b.ifExists=function(a){return b.decorator.ifExists=typeof a=="undefined"?!0:a,b},b.condition=function(a){return b.condition=a,b},b},h={Decorator:e,cloneStart:function(a){var b=a.decorator.stack.concat([]),c=new e(b);return c.ifExists=a.decorator.ifExists,c.createIfNecessary=a.decorator.createIfNecessary,g(c)},wrap:function(a,b){var c=a;return b.stack.forEach(function(a){c=a(c)}),c},createIfNecessary:function(){var a=g();return a.decorator.createIfNecessary=!0,a},ifExists:function(){var a=g();return a.decorator.ifExists=!0,a},condition:function(a){var b=g();return b.decorator.condition=a,b},up:function(a,b){if(typeof b!="function"||typeof a!="function")throw new Error("Composer.collide : you could only apply function together");return!!b.decorator&&b.decorator instanceof e?a.decorator&&a.decorator instanceof e?(a.decorator.stack=a.decorator.stack.concat(b.decorator.stack),a):h.wrap(a,b.decorator):b},bottom:function(a,b){if(typeof b!="function"||typeof a!="function")throw new Error("Composer.collide : you could only apply function together");return!!b.decorator&&b.decorator instanceof e?a.decorator&&a.decorator instanceof e?(b.decorator.stack=a.decorator.stack.concat(b.decorator.stack),b):h.wrap(a,b.decorator):b},around:function(a){return g().around(a)},after:function(a){return g().after(a)},before:function(a){return g().before(a)},fail:function(a){return g().fail(a)},parallele:function(a){return g().parallele(a)},replace:function(a){return g().replace(a)}};return h});if(typeof define!="function")var define=require("amdefine")(module);define("deep/utils",["require","./deep-collider","./deep-compose"],function(a){function l(a,b,c){return expString=a.split(/\s+/,b),expString.length==1?(c=c||10,expString[0].length>c?a.substring(0,c):expString[0]):(theNewString=expString.join(" "),theNewString.length<a.length&&theNewString[theNewString.length-1]!="."&&(theNewString+="..."),theNewString)}var b=a("./deep-collider"),c=a("./deep-compose"),d={};d.interpret=function(a,b){var c=a.indexOf("{");if(c==-1)return a;var e=a.substring(0,c);c++;var f=a.length;while(c<f){var g="";while(c<f&&a[c]!="}")a[c]!=" "&&(g+=a[c]),c++;a[c]=="}"&&(e+=d.retrieveValueByPath(b,g,"."),c++);while(c<f&&a[c]!="{")e+=a[c++];a[c]=="{"&&c++}return e},d.copyArray=function(a){return a?a.concat([]):[]},d.cloneFunction=function(a){var b=function(){return a.apply(this,arguments)};b.prototype=a.prototype;for(property in a)a.hasOwnProperty(property)&&(b[property]=d.copy(a[property]));return b},d.copy=function m(a){var b=null;if(a instanceof Array)b=[],a.forEach(function(a){b.push(m(a))});else if(a&&typeof a=="object"){if(a instanceof RegExp)return a;if(a instanceof Date)return new Date(a.valueOf());b={};for(var d in a){if(d=="_deep_entry")continue;a.hasOwnProperty(d)&&(b[d]=m(a[d]))}}else typeof a=="function"?a.decorator instanceof c.Decorator?b=c.cloneStart(a):b=a:b=a;return b},d.getObjectClass=function(a){if(a&&a.constructor&&a.constructor.toString){var b=a.constructor.toString().match(/function\s*(\w+)/);if(b&&b.length==2)return b[1]}return undefined},d.catchParenthesis=function(a){if(a[0]!="(")return null;var b=1,c=1,d="";while((a[b]!=")"||c>1)&&b<a.length)a[b]=="("&&c++,a[b]==")"&&c--,a[b]==")"?c>1&&(d+=a[b++]):d+=a[b++];return b++,{value:d,rest:a.substring(b)}},d.getMacroImport=function(a,b){var c="";if(a.layer&&a.layer.templates){var d=a.layer.templates.macros;for(var e in d){if(!d.hasOwnProperty(e)||b&&!e in b)continue;var f=d[e],g="",h=f.indexOf(":");h>-1&&(g=f.substring(0,h),f=f.substring(h+2)),c+="{% import '"+f+"' as "+e+" %}\n"}}return c},d.setValueByPath=function(b,c,d,e){var f=c.split(e||".");e=="/"&&f[0]==""&&f.shift();var g=b;while(f.length>1){var h=f.shift();if(!g[h])return null;g=g[h]}return g[f.shift()]=d},d.retrieveValueByPath=function(b,c,d){var e=c.split(d||".");d=="/"&&e[0]==""&&e.shift();var f=b;while(e.length>1){var g=e.shift();if(!f[g])return null;f=f[g]}return f?f[e.shift()]:null},d.deletePropertyByPath=function(b,c,d){var e=c.split(d||".");d=="/"&&e[0]==""&&e.shift();var f=b;while(e.length>1){var g=e.shift();if(!f[g])return;f=f[g]}delete f[e.shift()]},d.retrieveSchemaByPath=function(b,c,d){var e=c.split(d||".");d=="/"&&e[0]==""&&e.shift();var f=b;while(e.length>1){var g=e.shift();if(!f.properties||!f.properties[g])return null;f=f.properties[g]}return f.properties?f.properties[e.shift()]:null},d.arrayUnique=function(b,c){var e={},f=0,g=[];return b.forEach(function(a){var b=null;c?b=d.retrieveValueByPath(a,c):a.uri&&(b=a.uri);if(b==null||b==undefined)b=String(a);typeof e[b]=="undefined"&&(e[b]=!0,g.push(a))}),g},d.arrayFusion=function(b,c,e){var f={},g=0,h=[];return b&&b.length>0&&(h=h.concat(b)),h.forEach(function(a){var b=null;e?b=d.retrieveValueByPath(a,e):a.uri&&(b=a.uri);if(b==null||b==undefined)b=String(a);f[b]=!0}),c.forEach(function(a){var b=null;e?b=d.retrieveValueByPath(a,e):a.uri&&(b=a.uri);if(b==null||b==undefined)b=String(a);typeof f[b]=="undefined"&&h.push(a)}),h},d.inArray=function(b,c){if(!c||!c instanceof Array)return!1;var d={};c.forEach(function(a){d[a]=!0});if(b.forEach){var e=0;return b.forEach(function(a){typeof d[a]!="undefined"&&e++}),e==b.length?!0:!1}return d[b]?!0:!1},d.getJSPrimitiveType=function(a){return a instanceof Array?"array":typeof a},d.stripFirstSlash=function(a){return a.substring(0,1)=="/"?a.substring(1):a},d.deepEqual=function(a,b,c){c==undefined&&(c=!0);if(typeof a!=typeof b)return!1;if(typeof a=="object"){if(a==null&&a!==b)return!1;if(b==null&&a!==b)return!1;var e=!0,f=[],g=[];for(var h in b){if(h=="_deep_entry")continue;if(!b.hasOwnProperty(h))continue;if(typeof a[h]=="undefined")return!1;e=e&&d.deepEqual(a[h],b[h]);if(!e)return!1;g.push(h)}for(var h in a){if(h=="_deep_entry")continue;if(!a.hasOwnProperty(h))continue;f.push(h)}if(f.length!=g.length)return!1;if(c)for(var i=0;i<g.length;++i)if(g[i]!=f[i])return!1}else if(a!==b)return!1;return!0};var e=d.createStartEndRangeObject=function(a,b,c){var d={step:0,width:b-a+1,total:c,start:0,end:0};return c==0?d:(d.start=Math.max(Math.min(c-d.width,a),0),d.end=Math.max(Math.min(b,c),0),d.step=d.start/d.width,d)},f=d.createStepWidthRangeObject=function(a,b,c){var d={step:0,width:0,total:c,start:0,end:0};return c==0?d:(d.width=b,d.step=a,d.start=Math.round(a*b),d.end=Math.min(Math.round((a+1)*b)-1,c-1),d.start>=c&&(d.start=Math.max(c-b,0),d.step=d.start/d.width),console.log("step-width range : ",d),d)},g=d.retrieveFullSchemaByPath=function(a,b,c){var e=b.split(c||".");(e[0]==""||e[0]==".")&&e.shift();var f=a;while(e.length>1){var g=e.shift();if(g.match(/^[0-9]*$/)&&f.type=="array"){f=f.items||{};continue}if(!f.properties||!f.properties[g])return null;f=f.properties[g]}var h=e.shift(),i=[];if(h.match(/^[0-9]*$/))f.type=="array"&&(f=f.items||{},i.push(f));else{f.properties&&f.properties[h]&&i.push(f.properties[h]);if(f.patternProperties)for(var j in f.patternProperties)(new RegExp(j)).test(h)&&i.push(f.patternProperties[j]);if(i.length==0)return f.additionalProperties==undefined||f.additionalProperties==0?null:f.additionalProperties}var k={};return i.length>1?i.forEach(function(a){k=d.up(a,k)}):i.length==1&&(k=i[0]),k},h=d.deepArrayFusion=function(b,c,e){var f={},g=0,h=[],i={},j=null;return e&&(e.items&&(i=e.items),e.collision&&e.collision.unique&&(j=e.collision.unique===!0?null:e.collision.unique)),j?(b&&b.length>0&&(h=h.concat(b)),h.forEach(function(a){var b=null;j?b=d.retrieveValueByPath(a,j):a.uri?b=a.uri:a.name?b=a.name:a.id&&(b=a.id);if(b==null||b==undefined)b=String(a);f[b]={ref:a,index:g++}}),c.forEach(function(a){var b=null;j?b=d.retrieveValueByPath(a,j):a.uri?b=a.uri:a.name?b=a.name:a.id&&(b=a.id);if(b==null||b==undefined)b=String(a);f[b]?d.up(f[b].ref,a,!0,i,h,f[b].index):h.push(a)}),h):b.concat(c)},i=function(a,e,f,i,j){if(typeof a=="undefined")return e;if(a===null)return i&&j&&(i[j]=null),null;var k=null,l=d.getJSPrimitiveType(a),m=d.getJSPrimitiveType(e);if(l==="function")if(m==="function")if(a.decorator&&a.decorator instanceof c.Decorator){if(a.decorator.condition&&typeof a.decorator.condition=="function"&&!a.decorator.condition())return e;k=c.up(e,a)}else a._deep_collider?e._deep_collider?k=b.wrap(a,e):k=a(e,i,j):k=a;else if(a.decorator&&a.decorator instanceof c.Decorator){if(typeof e!="undefined")throw new Error("deep.compose need to be applied on function ! ");if(a.decorator.ifExists)return e;k=a}else a._deep_collider?k=a(e,i,j):k=a;if(k)return i&&j&&(i[j]=k),k;if(typeof e=="undefined"||e===null)return e=d.copy(a),i&&j&&(i[j]=e),e;if(l!==m)return e=d.copy(a),i&&j&&(i[j]=e),e;switch(l){case"array":return k=h(e,a,f),i&&j&&(i[j]=k),k;case"object":if(a instanceof RegExp)return i&&j&&(i[j]=a),a;if(a instanceof Date)return e=new Date(a.valueOf()),i&&j&&(i[j]=e),e;for(var n in a){if(n=="_deep_entry")continue;if(a[n]==null){e[n]=null;continue}if(a[n]&&a[n]._deep_colliderRemove){delete e[n];continue}var o={};f&&(o=g(f,n)),e[n]=d.up(a[n],e[n],o,e,n)}return e;default:return i&&j&&(i[j]=a),a}},j=function(a,e,f,i,j){if(a===null||typeof a=="undefined")return e;if(e==null)return e;if(typeof e=="undefined")return e=d.copy(a),i&&j&&(i[j]=e),e;var k=null,l=d.getJSPrimitiveType(a),m=d.getJSPrimitiveType(e);if(m==="function")if(l==="function")e.decorator&&e.decorator instanceof c.Decorator?k=c.bottom(a,e):e._deep_collider?a._deep_collider?k=b.wrap(e,a):k=e(a,i,j):k=e;else{if(e.decorator&&e.decorator instanceof c.Decorator)throw new Error("deep.compose need to be applied on function ! ");e._deep_collider?k=e(a,i,j):k=e}if(k)return i&&j&&(i[j]=k),k;if(l!==m)return e;switch(l){case"array":return k=h(a,e,f),i&&j&&(i[j]=k),console.log("array fusion bottom rsult : ",k,i,j,i[j]),k;case"object":var n={};for(var o in e){if(o=="_deep_entry")continue;n[o]=e[o],delete e[o]}for(var o in a){if(o=="_deep_entry")continue;e[o]=d.copy(a[o])}for(var o in n){if(o=="_deep_entry")continue;if(n[o]==null){e[o]=null;continue}if(n[o]&&n[o]._deep_colliderRemove){delete e[o];continue}var p={};f&&(p=g(f,o)),e[o]=d.up(n[o],e[o],p,e,o)}return e;default:return e}},k=d.deepCopy=function(b,c,e,f,g,h){return e=e!=null&&e!=undefined?e:!0,e?d.up(b,c,f,g,h):d.bottom(b,c,f,g,h)};return d.up=i,d.bottom=j,d.trimWords=function(a,b,c){var d=new RegExp("<[^>]*>","gi"),e=a.replace(d,"");return e=l(e,b,c),e},d}),define("deep/deep-rql",["require","./utils","rql/parser"],function(b){function i(a){return a&&(a instanceof Array||a.push)?"array":typeof a}function q(a,b){var c=function(c,d){typeof d=="undefined"&&(d=c,c=undefined);var e=arguments,f=[];for(var g=0,h=this.length;g<h;g++){var i=this[g];a(s(i,c),d)&&f.push(i)}return f};return c.condition=a,c}function r(a){return function(b){return b?this.map(function(a){return p(a,b)}).reduce(a):this.reduce(a)}}function s(a,b){return b instanceof Array?p(a,decodeURIComponent(b)):typeof b=="undefined"?p(a):p(a,decodeURIComponent(b))}function x(a,b,d){function k(){}function q(a){if(a&&typeof a=="object"){if(a instanceof Array)return"["+a.map(q)+"]";var b=c.jsOperatorMap[a.name];if(b){var d=a.args[0],e=a.args[1],f="";typeof e=="undefined"?(f="item",e=d,v&&(f+="."+v)):f="val&&val";var g=f+b+q(e);if(typeof Array.prototype.filter=="function")return"(function applyNativeArrayFilter(){return this.filter(function(item){var val = RQL_Global.retrieve(item,'"+d+"'); return "+g+"})})";throw"error : array have no filter"}return"(function(){var opo = RQL_Global.op('"+a.name+"');"+"return opo"+".call(this"+(a&&a.args&&a.args.length>0?", "+a.args.map(q).join(","):"")+")"+"})"}return typeof a=="string"?h(a):a}var e=b;d=d||{};var f=w[e];if(f)return a?f(a):f;try{var i=g(e,d.parameters)}catch(j){return console.log("deep-rql : parse error : ",e),j}prefix=d.prefix||null,v=prefix||null,u=d.schema||null,t=d.cache||null,k.prototype=c.operators;var l=new k,m=function(b){return l[b]||c.missingOperator(b)};RQL_Global.op=m;for(var n in d.operators)l[n]=d.operators[n];var o=d.parameters||[],p="",r="return "+q(i)+".call(target);",s=new Function("target",r);w[e]=s;try{return a?s(a):s}catch(j){throw console.log("WARNING : RQL throw : ",JSON.stringify(j)),j}}RQL_Global={};var c={},d=b("./utils"),e=d.retrieveFullSchemaByPath,f=b("rql/parser"),g=f.parseQuery,h=JSON.stringify||function(a){return'"'+a.replace(/"/g,'\\"')+'"'};c.jsOperatorMap={eq:"===",ne:"!==",le:"<=",ge:">=",lt:"<",gt:">"};var j=RQL_Global.isPresent=function(b,c){var d=[];return c.forEach(function(a){p(a,b)&&d.push(a)}),d},k=RQL_Global.rewritePath=function(b){var c=b||[];return typeof c=="string"&&(c=c.split(".")),v&&c[0]!="_schema"&&c[0]!="_parent"&&c.unshift(v),c},l=RQL_Global.retrieveSchemaProp=function(b,c,e,f){e[0]=="_schema"&&e.shift();var g=c;if(!c){if(e.length==1&&e[0]=="type")return e.shift(),i(f);if(e.length==1&&e[0]=="depth")return e.shift(),b.split("/").length;if(e.length==1&&e[0]=="class")return e.shift(),d.getObjectClass(f)}if(e.length==0||!g)return g||{};var h=d.retrieveValueByPath(g,e.join("."));return!h&&e.length==1&&e[0]=="type"?(e.shift(),i(f)):h},m=RQL_Global.retrieveParent=function(b,c,d){var e=b;while(e.ancestor&&d>0)e=e.ancestor,d--;return d!=0&&(e=null),e},n={},o=RQL_Global.getRetrieveFunc=function(b){if(n[b])return n[b];var c="",d=k(b);if(d.length==0)return n[b]=new Function("object","return object;");if(d[0]=="_parent"){var e=0;while(d.length>0&&d[0]=="_parent")e++,d.shift();c+="object = RQL_Global.retrieveParent(object, null, "+e+"); if(object == null) return null; ";if(d.length==0)return c+="return object;",n[b]=new Function("object",c);v&&d[0]!="_schema"&&d.unshift(v)}if(d[0]=="_schema"){d.shift(),c+="var res = RQL_Global.retrieveSchemaProp(object.path, object.schema, ['"+d.join("']['")+"'], "+(v?"object['"+v+"']":"object")+"); return res;";var f=new Function("object",c);return n[b]=f,f}c+="var fullPath = object.path;";var g=d[0],h=[],i="object",j=!1,l="";for(var m=0;d.length>0;m++){g=d.shift(),h.push(g),l=h.join("']['");if(g!="_schema")i+="&&object['"+l+"']";else{c+="if("+i+") object = object['"+l+"']; else return null;",c+="return RQL_Global.retrieveSchemaProp(fullPath+'."+h.join(".")+"', object.schema, ['"+d.join("']['")+"'], object);",j=!0;break}}j||(c+="if("+i+") return object['"+l+"']; else return null;");var f=new Function("object",c);return n[b]=f},p=function(b,c){var d=o(c)(b);return d};RQL_Global.retrieve=p,c.instanceOfs={Array:{}},c.operators={sort:function(){var b=[];for(var c=0;c<arguments.length;c++){var d=arguments[c],e=d.charAt(0),f={attribute:d,ascending:!0};if(e=="-"||e=="+")e=="-"&&(f.ascending=!1),f.attribute=f.attribute.substring(1);b.push(f)}return this.sort(function(a,c){for(var d,e=0;d=b[e];e++){var f=p(a,d.attribute),g=p(c,d.attribute);if(f!=g)return d.ascending==f>g?1:-1}return 0}),this},match:q(function(b,c){return(new RegExp(c)).test(p(b))}),instanceOf:function(b,d){var e=!1,f=0;for(var g in d){c.instanceOfs&&c.instanceOfs[g]?e=e&&c.instanceOfs[g](b):e=!1;if(!e)break}return e},"in":q(function(b,c){var d=!1,e=0;while(!d&&e<c.length)c[e++]==b&&(d=!0);return d}),out:q(function(b,c){var d=!0,e=0;while(d&&e<c.length)c[e++]==b&&(d=!1);return d}),contains:q(function(b,c){return d.inArray(c,b)}),excludes:q(function(b,c){return!d.inArray(c,b)}),or:function(){var b=[];for(var c=0;c<arguments.length;++c)typeof arguments[c]=="function"?b=b.concat(arguments[c].call(this)):b=b.concat(j(arguments[c],b));return b},and:function(){var b=this;for(var c=0;c<arguments.length;++c)typeof arguments[c]=="function"?b=arguments[c].call(b):b=j(arguments[c],b);return b},select:function(){var b=arguments,c=arguments.length;return this.map(function(a){var d={};for(var e=0;e<c;e++){var f=b[e],g=s(a,f);typeof g!="undefined"&&(d[f]=g)}return d})},unselect:function(){var b=arguments,c=arguments.length;return this.map(function(a){var d={};for(var e in a)a.hasOwnProperty(e)&&(d[e]=a[e]);for(var e=0;e<c;e++)delete d[b[e]];return d})},values:function(b){if(arguments.length==1)return this.map(function(a){return p(a,b)});var c=arguments,d=arguments.length;return this.map(function(a){var b=p(a),e=[];if(d===0)for(var f in b)b.hasOwnProperty(f)&&e.push(b[f]);else for(var f=0;f<d;f++){var g=c[f];e.push(b[g])}return e})},limit:function(b,c,d){var e=this.length;c=c||0;var f=this.slice(c,c+b);return d&&(f.start=c,f.end=c+f.length-1,f.totalCount=Math.min(e,typeof d=="number"?d:Infinity)),f},distinct:function(){var b={},c=[],d=this.filter(function(a){return a=p(a),a&&typeof a=="object"?a.__found__?!1:(a.__found__=function(){},c.push(a),!0):b[a]?!1:(b[a]=!0,!0)});return c.forEach(function(a){delete a.__found__}),d},recurse:function(b){function d(a){if(a instanceof Array)a.forEach(d);else{c.push(a);if(b)a=a[b],a&&typeof a=="object"&&d(a);else for(var e in a)a[e]&&typeof a[e]=="object"&&d(a[e])}}var c=[];return d(p(this)),c},aggregate:function(){var b=[],c=[];for(var d=0;d<arguments.length;d++){var e=arguments[d];typeof e=="function"?c.push(e):b.push(e)}var f={},g=b.length;this.forEach(function(a){a=p(a);var c="";for(var d=0;d<g;d++)c+="/"+a[b[d]];var e=f[c];e||(e=f[c]=[]),e.push(a)});var h=c.length,i=[];for(var j in f){var k=f[j],l={};for(var d=0;d<g;d++){var m=b[d];l[m]=k[0][m]}for(var d=0;d<h;d++){var n=c[d];l[d]=n.call(k)}i.push(l)}return i},between:q(function(b,c){return b=p(b),b>=c[0]&&b<c[1]}),sum:r(function(b,c){var b=p(b),c=p(c);return b+c}),mean:function(b){return c.operators.sum.call(this,b)/this.length},max:r(function(b,c){var b=p(b),c=p(c);return Math.max(b,c)}),min:r(function(b,c){var b=p(b),c=p(c);return Math.min(b,c)}),count:function(){return this.length},first:function(){return this[0]},last:function(){return this[this.length-1]},random:function(){return this[Math.round(Math.random()*(this.length-1))]},one:function(){if(this.length>1)throw new TypeError("More than one object found");return this[0]}},c.filter=q,c.evaluateProperty=s,c.executeQuery=function(b,d,e){return c.query(b,d,e)},c.query=x,c.missingOperator=function(b){throw new Error("Operator "+b+" is not defined")};var t=null,u=null,v=null,w={};return c}),define("deep/deep-schema",["require","./utils","./promise"],function(a){function d(a,b){var c=[];for(var d in b){if(!b.hasOwnProperty(d))continue;(new RegExp(d)).test(a)&&c.push(b[d])}return c}var b=a("./utils"),c=a("./promise"),e=function(){},f=e.prototype.getType=function(a){for(var b in this.lexic.type)if(this.lexic.type.hasOwnProperty(b)&&b!="any"&&b!="object"&&b!="schema"&&this.lexic.type[b].test.apply(this,[a]))return b;return this.lexic.type.object.test.apply(this,[a])?"object":null};e.prototype.convertStringTo=function(a,b){switch(b){case"number":a=parseFloat(a);break;case"float":a=parseFloat(a);break;case"integer":a=parseInt(a);break;case"boolean":a=a=="true"||a=="1"?!0:!1;break;default:a}return a},e.prototype.errors=null,e.prototype.errorsMap=null,e.prototype.doTest=function(b,c,d,e,f,g,h){b.test&&!b.test.apply(this,[c,d,e,f,g,h])&&this.createError(b.error,c,d,e,f,g,h)},e.prototype.createError=function(b,c,d,e,f,g,h){h||(h="");var i=swig.compile(b)({value:c,type:d,path:f,schema:e,schemaPath:g,__this:this}),j={detail:i,value:c,type:d,schema:e,path:f,schemaPath:g,schemaProperty:h};return this.errorsMap||(this.errorsMap={}),this.errorsMap[f]||(this.errorsMap[f]={}),this.errorsMap[f].errors||(this.errorsMap[f].errors=[]),this.errorsMap[f].errors.push(j),console.flags.validationError&&console.log("validator","create error : ",JSON.stringify(j)),this.errors.push(j),j},e.prototype.checkRef=function(b,c,d,e,f){f==undefined&&(f=this.validateProperty);var g=this;return f.apply(g,[b,c,d,e])},e.prototype.validateSchema=function(b,d){this.errorsMap={},this.errors=[];var e=this,f=c.Deferred();this.options=d|{},this.options.basePath||(this.options.basePath=""),this.options.baseSchemaPath||(this.options.baseSchemaPath=""),this.validateSchemaProperties(null,b,null,this.options.basePath);var g={errorsMap:e.errorsMap,schema:b,value:null,date:Date.now(),valid:e.errors.length==0};return g},e.prototype.validate=function(b,c,d){this.rootValue=b,this.errors=[],this.errorsMap={};var e=this;this.options=d||{},this.options.basePath||(this.options.basePath=""),this.options.baseSchemaPath||(this.options.baseSchemaPath=""),this.validateProperty(b,c,this.options.basePath,this.options.baseSchemaPath);var f={errorsMap:e.errorsMap,schema:c,value:b,date:Date.now(),valid:e.errors.length==0};return f},e.prototype.partialValidation=function(d,e,f){this.errors=[],this.errorsMap={},this.options=f||{};var g=f.fieldsToCheck||[],h=[],i=[],j=[],k=c.Deferred(),l=this;return console.log("Validator","partialValidation : fieldsToCheck = "+g),g.forEach(function(a){var c=b.retrieveFullSchemaByPath(e,a);if(!c)return;var f=b.retrieveValueByPath(d,a);if(f!=""&&!f&&c.required){l.createError(l.lexic[l.lexic.__requiredEquivalent].error,f,"undefined",c,a);return}i.push(l.validate(f,c,{basePath:a,baseSchemaPath:null}))}),c.all(i).then(function(b){var c=!0;b.forEach(function(b){if(!b.valid){c=!1;for(var d in b.errorsMap)l.errorsMap[d]||(l.errorsMap[d]={errors:[]}),l.errorsMap[d].errors=b.errorsMap[d].errors}}),k.resolve({schema:e,value:d,errorsMap:l.errorsMap,valid:c,date:Date.now(),partial:!0})}),c.promise(k)},e.prototype.validateSchemaProperties=function(b,c,d,e){var g=[];for(var h in c){if(!c.hasOwnProperty(h))continue;var i=f.apply(this,[c[h]]);switch(h){case"type":(typeof c.type!="string"||!this.lexic.type[c.type])&&this.createError(this.lexic.__additionalErrors.unknownSchemaType,c.type,this.getType(c.type),null,null,e,"type");break;case"format":(typeof c.format!="string"||!this.lexic.__defaultPattern[c.format])&&this.createError(this.lexic.__additionalErrors.unknownFormatType,c.format,this.getType(c.format),null,null,e,"format");break;case"pattern":(typeof c.pattern!="string"||!this.lexic.__defaultPattern[c.pattern])&&this.createError(this.lexic.__additionalErrors.unknownFormatType,c.pattern,this.getType(c.pattern),null,null,e,"pattern");break;default:g.push(this.checkRef(c[h],this.lexic[h].schema,e,h+".schema"))}}return g},e.prototype.validateProperty=function(a,c,e,g){var h=[],i=this.getType(a);if(this.options.forceConversion&&c.type!=i)switch(c.type){case"number":a=parseFloat(a);break;case"float":a=parseFloat(a);break;case"integer":a=parseInt(a);break;case"boolean":a=a=="true"||a=="1"||a==1?!0:!1;break;default:}var j=this;i==null&&(i=typeof a),c.type||(c.type="object");var k=c.type;k.push||(k=[k]);var l=!1;for(var m=0;m<k.length;++m){if(k[m]=="schema"){i!="object"?this.createError(this.lexic.__additionalErrors.schemaIsNotObject,a,i,c,e,g,g+".type"):h.push(this.validateSchemaProperties(null,a,null,e));return}if(!this.lexic.type[k[m]]){this.createError(this.lexic.__additionalErrors.unknownSchemaType,a,i,c,e,g,g+".type");continue}if(i==k[m]||k[m]=="any"){l=!0;break}}l||this.createError(this.lexic.__additionalErrors.badType,a,i,c,e,g,g+".type");var n=!1;c.dependencies&&c.dependencies.length>0&&c.dependencies.forEach(function(b){var c=Querier.query(a,b.query);if(c.length>0){n=!0;var d=j.validateProperty(a,b.constraints,e,g);l=l&&d.valid}});if(!n&&c.items&&i=="array")if(c.items.push){var m=0;for(;m<c.items.length;++m)h.push(this.checkRef(a[m],c.items[m],e+"."+m,g+".items["+m+"]"));if(m<a.length&&(c.additionalItems==undefined||c.additionalItems!==!1))for(;m<a.length;++m)h.push(this.checkRef(a[m],c.additionalItems||{},e+"["+m+"]",g+".additionalItems"));else c.additionalItems===!1&&this.createError(this.lexic.additionalItems.error,a,i,c,e+"["+m+"]",g+".items")}else for(var m=0;m<a.length;++m)h.push(this.checkRef(a[m],c.items,e+"."+m,g+".items"));if(!n&&i=="object"){for(var m in a){if(!a.hasOwnProperty(m))continue;var o=[];c.patternProperties&&(o=d(m,c.patternProperties)),c.properties&&c.properties[m]&&o.push(c.properties[m]);if(o.length==0)c.additionalProperties==undefined||c.additionalProperties!==!1?h.push(this.checkRef(a[m],c.additionalProperties||{type:"any"},e+"."+m,g+".additionalProperties")):c.additionalProperties===!1&&this.createError(this.lexic.additionalProperties.error,a[m],f.apply(this,[a[m]]),c,e+"."+m,g+".properties."+m);else{var p={};o.forEach(function(c){b.deepCopy(c,p)}),h.push(this.checkRef(a[m],p,e+"."+m,g+".(merged)properties."+m))}}if(this.lexic[this.lexic.__requiredEquivalent].schema.type=="boolean")for(var m in c.properties)c.properties[m][this.lexic.__requiredEquivalent]&&typeof a[m]=="undefined"&&this.createError(this.lexic[this.lexic.__requiredEquivalent].error,a[m],"undefined",c,e+"."+m,g+".properties."+m)}if(!n)for(var m in c){if(!c.hasOwnProperty(m))continue;switch(m){case"type":break;case"properties":break;case"dependencies":break;case"patternProperties":break;case"items":break;case"additionalItems":break;case"additionalProperties":break;default:this.lexic[m]?this.doTest(this.lexic[m],a,i,c,e,g):console.flags.validator&&console.log("validator","unrecognised schema property : "+m)}}return h},e.prototype.applyLexic=function(c){b.up(c,this.lexic)},e.prototype.lexic={__additionalErrors:{schemaIsNotObject:"{{ path }}, trying to validate a schema (type:'schema') but the value isn't an object : Value provided : {{ value }}",badType:"{{ path }}, type not allowed. Allowed type :  {{ schema.type }}",unknownSchemaType:"type from schema is unknown : {{ schema.type }}"},__requiredEquivalent:"required",__defaultPattern:{uri:{test:function(a){return/.*/g.test(a)},error:"need to be with uri format"},date:{test:function(a){return/.*/g.test(a)},error:"need to be with date format"},phone:{test:function(a){return/.*/g.test(a)},error:"need to be with phone format"},email:{test:function(a){return/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}$/gi.test(a)},error:"need to be with email format"},zip:{test:function(a){return/.*/g.test(a)},error:"need to be with zip format"},ipv4:{test:function(a){return/.*/g.test(a)},error:"need to be with ipv4 format"},ipv6:{test:function(a){return/.*/g.test(a)},error:"need to be with ipv6 format"},"date-time":{test:function(a){return/.*/g.test(a)},error:"need to be with date-time format"},"utc-millisec":{test:function(a){return/.*/g.test(a)},error:"need to be with date-time format"}},type:{any:{test:function(a){return!0}},object:{test:function(a){return typeof a=="object"},error:"{{ path }} need to be float. Value provided : {{ value }}"},"boolean":{test:function(a){return a===!0||a===!1},error:"{{ path }} need to be float. Value provided : {{ value }}"},number:{test:function(a){return typeof a=="number"&&!isNaN(a)},error:"{{ path }} need to be float. Value provided : {{ value }}"},integer:{test:function(a){return typeof a=="number"&&parseInt(String(a))!=NaN},error:"{{ path }} need to be integer. Value provided : {{ value }}"},"null":{test:function(a){return a===null},error:"{{ path }} need to be null. Value provided : {{ value }}"},string:{test:function(a){return typeof a=="string"},error:"{{ path }} need to be string. Value provided : {{ value }}"},array:{test:function(a){return a instanceof Array},error:"{{ path }} need to be array. Value provided : {{ value }}"},schema:{test:function(a){return typeof a=="object"},error:"{{ path }} need to be true. Value provided : {{ value }}"}},dependencies:{schema:{type:"array",items:{properties:{query:{type:"string",required:!0},constraints:{type:"schema"}}}},test:function(a,c,d,e,f){var g=this,h=!0;return d.dependencies&&d.dependencies.length>0&&d.dependencies.forEach(function(c){var i=Querier.query(a,c.query);if(i.length>0){var j={};for(var k in d){if(!d.hasOwnProperty(k)||k=="dependencies")continue;j[k]=b.deepCopy(d[k],{})}j=b.deepCopy(c.constraints,j);var l=g.validateProperty(a,j,e,f);h=h&&l.valid}}),!0},error:"{{ path }} unmatched dependency {{ schema.dependencies }}. Value provided : {{ value|json }}"},format:{schema:{type:"string"},test:function(a,b,c,d,e){return!a&&!c.required?!0:b=="array"||b=="object"?!0:this.lexic.__defaultPattern[c.format]?this.lexic.__defaultPattern[c.format].test.apply(this,[a,b,c,d,e,e+".format"]):(new RegExp(c.format)).test(String(a))},error:"{{ path }} unmatched format {{ schema.format }}. Value provided : {{ value }}"},pattern:{schema:{type:"string"},test:function(a,b,c,d,e){return!a&&!c.required?!0:b=="array"||b=="object"?!0:this.lexic.__defaultPattern[c.pattern]?this.doTest(this.lexic.__defaultPattern[c.pattern],a,b,c,d,e,e+".pattern"):(new RegExp(c.pattern)).searchInterpretable(String(a))},error:"{{ path }} unmatched pattern {{ schema.pattern }}. Value provided : {{ value }}"},minLength:{schema:{type:"integer"},test:function(a,b,c){return b!="array"&&b!="string"&&b!="integer"?!0:(!a||a=="")&&!c.required?!0:a.length>=c.minLength},error:"{{ path }} need to be at least {{ schema.minLength }} length. Value provided : {{ value }}"},maxLength:{schema:{type:"integer"},test:function(a,b,c){return(!a||a=="")&&!c.required?!0:b!="array"&&b!="string"&&b!="integer"?!0:a.length<=c.maxLength},error:"{{ path }} need to be at max {{ schema.minLength }} length. Value provided : {{ value }}"},minimum:{schema:{type:"number"},test:function(a,b,c){return b!="number"&&b!="integer"?!0:(!a||a=="")&&!c.required?!0:c.exclusiveMinimum?a>c.minimum:a>=c.minimum},error:"{{ path }} need to be at least {{ schema.exclusiveMinimum }}. Value provided : {{ value }}"},maximum:{schema:{type:"number"},test:function(a,b,c){return b!="number"&&b!="integer"?!0:!a&&!c.required?!0:c.exclusiveMaximum?a<c.maximum:a<=c.maximum},error:"{{ path }} need to be max {{ schema.exclusiveMaximum }}. Value provided : {{ value }}"},minItems:{schema:{type:"integer"},test:function(a,b,c){return!a&&!c.required?!0:b!="array"?!0:a.length>=c.minItems},error:"{{ path }} need to be at least {{ schema.minItems }} long. Value provided : {{ value|json }}"},maxItems:{schema:{type:"integer"},test:function(a,b,c){return(!a||a=="")&&!c.required?!0:b!="array"?!0:a.length<=c.maxItems},error:"{{ path }} need to be at max {{ schema.maxItems }} long. Value provided : {{ value|json }}"},required:{schema:{type:"boolean"},test:function(a,b,c){return typeof a!="undefined"},error:"{{ path }} is required and is missing."},"enum":{schema:{type:"array",items:{type:"string"}},test:function(a,b,c){if(typeof a!="undefined"&&a!=""||!!c.required){if(b!="string"&&b!="number"&&b!="integer")return!0;var d=!1;for(var e=0;e<c["enum"].length;++e)if(a==c["enum"][e]){d=!0;break}return d}return!0},error:"{{ path }} need to be equal to one of those values {{ schema.enum|join_coma }}. Value provided : {{ value }}"},disallow:{schema:{type:["array","string"],"enum":["string","array","number","integer","date","function","null","object"],items:{type:"string","enum":["string","array","number","integer","date","function","null","object"]}},test:function(a,b,c){if(!a&&!c.required)return!0;if(typeof disallow.push!="function")return c.disallow!==b;for(var d in c.disallow)if(c.disallow[d]==b)return!1;return!0},error:"{{ path }} need to be of different type than {{ schema.disallow|join_coma }}. type provided : {{ type }}"},divisibleBy:{schema:{type:"integer",minimum:1,absoluteMinimum:!0},test:function(a,b,c){return!a&&!c.required?!0:b!="number"&&b!="integer"?!0:a%c.divisibleBy==0},error:"{{ path }} ( value : {{ value }}) need to be divisible by {{ schema.divisibleBy }}."},uniqueItems:{schema:{type:"boolean"},test:function(a,c,d){if(c!="array")return!0;if(!a&&!d.required)return!0;if(!d.uniqueItems)return!0;var e=b.arrayFusion(a,a);return e.length==a.length},error:"each item need to be unique"},exclusiveMinimum:{schema:{type:"boolean"}},exclusiveMaximum:{schema:{type:"boolean"}},"default":{schema:{type:"any"}},title:{schema:{type:"string"}},description:{schema:{type:"string"}},id:{schema:{type:"string"}},readOnly:{schema:{type:"boolean"}},backgrounds:{schema:{type:["string","array"],items:{type:"string"},loadable:"direct"}},$schema:{schema:{type:"string",items:{type:"string"}},test:function(a,b,c){return console&&console.log("$schema isn't implemented in this validator and will not be implemented (due to his self definition method)"),!0}},$ref:{schema:{type:"string"}},links:{schema:{type:"array",items:{type:"object",properties:{rel:{type:"string",required:!0},href:{type:"string",required:!0},template:{type:"string"},targetSchema:{type:"string"},method:{type:"string","enum":["GET","PUT","POST","DELETE"]},enctype:{type:"string","default":"application/json"},schema:{type:"schema"}}}}},additionalProperties:{schema:{type:["false","schema"]},error:"no additional properties are allowed"},patternProperties:{schema:{type:"object",patternProperties:{"/.*/g":{type:"schema"}}}},properties:{schema:{type:"object",patternProperties:{"/.*/g":{type:"schema"}}}},contentEncoding:{schema:{type:"string"}},mediaType:{schema:{type:"string"}},additionalItems:{schema:{type:["false","schema"]},error:"no additional items are allowed"},items:{schema:{type:["array","schema"],items:{type:"schema"}}}};var g={divisibleBy:{$ommit:!0},mod:{schema:{type:"integer",minimum:1,absoluteMinimum:!0},test:function(a,b,c){return!a&&!c.required?!0:b!="number"&&b!="integer"?!0:a%c.mod==0},error:"need to be divisible by {{ schema.divisibleBy }}"},maxProperties:{schema:{type:"integer",minimum:0},test:function(a,b,c){var d=0;for(var e in a){if(!a.hasOwnProperties(e))continue;d++}return d<=c.maxProperties},error:"need to have maximum {{ schema.maxProperties }} properties"},minProperties:{schema:{type:"integer",minimum:0},test:function(a,b,c){var d=0;for(var e in a){if(!a.hasOwnProperties(e))continue;d++}return d>=c.minProperties},error:"need to have minimum {{ schema.maxProperties }} properties"}},h={__defaultPattern:{retrievable:{test:function(a){return!a&&!schema.required?!0:DeepRequest.isRetrievable(a).type!=null},error:"need to be in 'retrievable' format. (see deep/deep-request/isRetrievable())"}},merge:{schema:{type:["string","boolean"]}},loadable:{schema:{type:"string","enum":["deep","direct","none"]}},preload:{schema:{type:"boolean",required:!1,"default":!0}},reloadable:{schema:{type:"boolean"}},"interpretation-deepness":{schema:{type:"string","enum":["deep","direct","none"]}}},i={type:{},notNull:{schema:{type:"boolean"},test:function(a,b,c){return!a&&!c.required?!0:c.notNull?a!==null:!0},error:"need to be not null"},absoluteMaximum:{schema:{type:"boolean"}},absoluteMinimum:{schema:{type:"boolean"}},minimum:{test:function(a,b,c){return!a&&!c.required?!0:b!="number"&&b!="integer"?!0:(c.absoluteMinimum&&(a=Math.abs(a)),c.exclusiveMinimum?a>c.minimum:a>=c.minimum)}},maximum:{test:function(a,b,c){return!a&&!c.required?!0:b!="number"&&b!="integer"?!0:(c.absoluteMaximum&&(a=Math.abs(a)),c.exclusiveMaximum?a<c.maximum:a<=c.maximum)}},needMatchingOn:{schema:{type:"string"},test:function(a,b,c){if(!a&&!c.required)return!0;var d=c.needMatchingOn;d[0]=="#"&&(d=d.substring(1));var e=Querier.query(this.rootValue,d);return e.length>0&&e[0]==a},error:"this field need to match {{ schema.needMatchingOn }}"}},j={type:{"function":{test:function(a){return typeof a=="function"},error:"need to be a function"},"false":{test:function(a){return a===!1},error:"need to be false"},"true":{test:function(a){return a===!0},error:"need to be true"},date:{test:function(a){return a?typeof a.toUTCString=="function":!1},error:"need to be a date object"}}},k={__defaultPattern:{"coordination-number":{test:function(a,b,c){if(b!="string")return!0;if(!c.required&&!a)return!0;if(!a)return!1;var d=a+"";if(d.length!=10)return!1;var d=a.substring(4,5);return d=parseInt(d),d<60||d>91?!1:!0},error:"need to be in coordination-number format"},"personal-number":{test:function(a,b,c){if(b!="string")return!0;if(!c.required&&!a)return!0;if(!a)return!1;var d=a+"";if(d.length!=10)return!1;var d=a.substring(4,5);return d=parseInt(d),d<60||d>91?!1:!0},error:"need to be in personal-number format"}}};b.deepCopy(g,e.prototype.lexic),b.deepCopy(j,e.prototype.lexic),b.deepCopy(i,e.prototype.lexic),b.deepCopy(k,e.prototype.lexic);var l=new e;return e.convertStringTo=function(a,b){return l.convertStringTo(a,b)},e.validate=function(a,b,c){return l.validate(a,b,c)},e.getType=function(a){return l.getType(a)},e.partialValidation=function(a,b,c){return l.partialValidation(a,b,c)},e}),define("deep/deep-query",["require","./deep-rql","./utils"],function(b){var c=b("./deep-rql").query,d=b("./utils"),e=Error,f=d.retrieveFullSchemaByPath,g=function(){};g.prototype.analyseEreg=function(b,c){var e=d.catchParenthesis(b),f=e.value,g="",h=e.rest,i=this;if(h[0]=="g"||h[0]=="i"){g=h[0];if(h[1]=="g"||h[1]=="i")g+=h[1]}return h=h.substring(g.length),c.push({type:"selector",value:f,options:g,handler:function(a){var b=[];for(var c in a.value){if(c=="_deep_entry")continue;if((new RegExp(this.value,this.options)).test(c)){var d=i.returnProperty(a,c);typeof d!="undefined"&&d!=null&&b.push(d)}}return b}}),h},g.prototype.analyse=function(a){var b=[],c=a;this.asked=a;while(c.length>0){var c=this.analyseMoves(c,b);if(b.length==0)throw new e("deep-queries need at least one move.",a);if(c.length==0)break;c=this.analyseSelector(c,b);if(c.length==0)break;c[0]=="?"&&(c=this.analyseRQL(c,b))}var d=this;return b.length>0&&b[b.length-1].slashes=="/"&&b.push({type:"selector",value:"*",handler:function(a){return d.returnAllProps(a)}}),console.flags&&console.flags["deep-query"]&&(console.log("dq analayse : ",a),console.log(" : gives : "+JSON.stringify(b,null," "))),b},g.prototype.analyseRQL=function(a,b){if(a[0]!="?")return a;a=a.substring(1);if(a[0]=="("){var e=d.catchParenthesis(a);return b.push({type:"rql",value:e.value,handler:function(a){return c(a,e.value,{prefix:"value",fromDeepQuery:!0})}}),e.rest}var f=0,g="";while(a[f]!="/"&&f<a.length)g+=a[f++];return b.push({type:"rql",value:g,handler:function(a){try{var b=c(a,g,{prefix:"value",fromDeepQuery:!0})}catch(d){return console.log("deep-query : rql errors : ",d),[]}return b}}),a.substring(f)},g.prototype.analyseIndexAccess=function(a,b){var c="",d=0;while(a[d]!="/"&&a[d]!="?"&&d<a.length)c+=a[d++];var f=c.split(":"),g=this,h={type:"selector",handler:function(a){var b=this.start(a);if(b==-1)return[];if(this.end===null){var c=g.returnProperty(a,b);return c!=null&&typeof c!="undefined"?[c]:[]}var d=[];for(var e=b;e<=this.end(a);e+=this.step(a)){var c=g.returnProperty(a,e);c!=null&&typeof c!="undefined"&&d.push(c)}return d},start:null,end:null,step:function(a){return 1}},i=0,j=null;return f.forEach(function(c){if(c=="")i==0?j=function(a){return 0}:i==1?j=function(a){return a.value.length!==undefined?a.value.length-1:-1}:j=function(a){return 1};else if(c.substring(0,8)=="@.length"){var d=c.substring(8);if(d.length==0||d[0]!="-")throw new e("when you use @.length : you could only use minus '-' operator followed by an integer.",a,b);var f=parseInt(d.substring(1));if(isNaN(f))throw new e("when you use @.length : you could only use minus '-' operator followed by an integer.",a,b);j=function(a){if(a.value.length!==undefined){var b=Math.min(f,a.value.length);return b-f}return-1}}else{var g=parseInt(c);if(isNaN(g))throw new e("bad index : index unknown",a,b);j=function(a){return g}}i==0?h.start=j:i==1?h.end=j:h.step=j,i++}),b.push(h),a.substring(d)},g.prototype.analyseUnionAccess=function(a,b){if(a[0]!="[")throw new e("union access need to start with '['.",a,b);var c="",d=this,f=1;while(a[f]!="]"&&f<a.length)c+=a[f++];var g=c.split(",");if(g.length==0)return b.push({type:"selector",value:"*",handler:function(a){return self.returnAllProps(a)}}),a.substring(f+1);var h={type:"selector",selectors:[],handler:function(a){var b=[];return this.selectors.forEach(function(c){var d=c.handler(a);d&&(b=b.concat(d))}),b}};return g.forEach(function(a){d.analyseSelector(a,h.selectors,!0)}),b.push(h),a.substring(f+1)},g.prototype.createEntry=function(a,b){var c=b.path;c[c.length-1]=="/"?c+=a:c+="/"+a;var d=null;return b.schema&&(d=f(b.schema,a,"/")),this.cache[c]={_isDQ_NODE_:!0,root:b.root,value:b.value[a],path:c,key:a,ancestor:b,schema:d,depth:b.depth+1}},g.prototype.returnProperty=function(a,b){if(b=="_deep_entry")return null;if(typeof a.value=="string"&&b!=="length")return null;var c=a.value;return typeof c[b]!="undefined"?a=this.createEntry(b,a):a=null,a},g.prototype.returnAllProps=function(a){if(typeof a.value=="string")return[];var b=a.value,c=[];for(var d in b){if(d=="_deep_entry")continue;if(!b.hasOwnProperty(d))continue;var e=this.createEntry(d,a);typeof e!="undefined"&&c.push(e)}return c},g.prototype.returnRecursiveProps=function(a){if(typeof a.value=="string")return[];var b=a.value,c=[],d=this;for(var e in b){if(!b.hasOwnProperty(e))continue;if(e=="_deep_entry")continue;var f=d.createEntry(e,a);typeof f!="undefined"&&c.push(f),typeof b[e]=="object"&&(c=c.concat(d.returnRecursiveProps(f)))}return c},g.prototype.analyseSelector=function(a,b,c){var d=0,f=this;if(a.length==0)return b.length>1&&b[b.length-1].slashes=="//"?a:(b.push({type:"selector",value:"*",handler:function(a){return f.returnAllProps(a)}}),a);if(a[0]=="?"){if(c)throw new e("you couldn't have '?' (rql) in an union of selectors.",a,b);return b[b.length-1].slashes=="//"?a:(b.push({type:"selector",value:"*",handler:function(a){return f.returnAllProps(a)}}),a)}if(a[0]=="!")return b.push({type:"selector",value:"!",handler:function(a){return a?[a]:[]}}),a.substring(1);if(a[0]=="(")return this.analyseEreg(a,b);if(/^[0-9]/.test(a[0])||a[0]=="@"||a[0]==":")return this.analyseIndexAccess(a,b);if(a[0]=="["){if(c)throw new e("you couldn't have union in union of selectors.",a,b);return this.analyseUnionAccess(a,b)}var g="";while(a[d]!="/"&&a[d]!="?"&&d<a.length)g+=a[d++];return g=="*"?b[b.length-1].slashes=="//"?a.substring(d):(b.push({type:"selector",value:"*",handler:function(a){return f.returnAllProps(a)}}),a.substring(d)):(b.push({type:"selector",value:g,handler:function(a){var b=f.returnProperty(a,g);return b!=null&&typeof b!="undefined"?[b]:[]}}),a.substring(d))},g.prototype.analyseMoves=function(a,b){var c=[],d="",f=0;while(f<a.length&&(a[f]=="."||a[f]=="/")){while(a[f]=="/")d+="/",f++;if(d.length>0){if(d.length>2)throw new e("bad move : ",a);c.push(d),d=""}while(a[f]==".")d+=".",f++;if(d.length>0){if(d.length>3)throw new e("bad move : ",a);c.push(d),d=""}}var g=c[c.length-1];if(!g)throw new e("deepQuery : missformed query : "+this.asked);g[0]=="."&&(f-=g.length);while(c.length>0){var h={type:"move",points:null,slashes:null},i=c.shift();i[0]=="."&&(h.points=i,i=c.shift());if(i!="/"&&i!="//")throw new e("bad move : "+JSON.stringify(a)+" - "+i);h.slashes=i,b.push(h)}return a.substring(f)},g.prototype.doMove=function(a,b,c){var d=[],f=a,g=this;return b.forEach(function(a){if(f.points)switch(f.points){case".":d.push(a);break;case"..":a.ancestor&&d.push(a.ancestor);break;case"...":var b=a;while(b.ancestor)d.push(b.ancestor),b=b.ancestor;break;default:throw new e("bad move : ",f)}f.points||(c?d.push(g.root):d.push(a)),f.slashes=="//"&&(d=d.concat(g.returnRecursiveProps(a)))}),d},g.prototype.query=function(a,b,c){if(typeof a!="object")return[];c=c||{};if(!this.cache||!c.keepQueryCache)this.cache={};var f=null;b[0]==="#"&&(b=b.substring(1));var h=this.analyse(b);if(h.length==0||h[0].type!="move")throw new e("query need to start with move : "+b);a&&a._isDQ_NODE_==1?(this.root=this.cache["/"]=a.root||a,f=[a]):a&&a._deep_entry?(this.root=this.cache["/"]=a._deep_entry.root,f=[a._deep_entry]):(this.root=this.cache["/"]=g.createRootNode(a,c.schema),f=[this.cache["/"]]),f[0].root=this.root;var i=this,j=!0;while(h.length>0){var k=h.shift();switch(k.type){case"move":f=i.doMove(k,f,j);break;case"selector":var l=[];f.forEach(function(a){var b=k.handler(a);b&&b.length>0&&(l=l.concat(b))}),f=l;break;case"rql":f=k.handler(f)}j=!1}f=d.arrayUnique(f,"path");if(c.resultType=="full")return f;var m=[];return f.forEach(function(a){m.push(a.value)}),m};var h=null;return g.query=function(a,b,c){return h||(h=new g),h.query(a,b,c)},g.createRootNode=function(a,b){return{_isDQ_NODE_:!0,value:a,path:"/",key:null,ancestor:null,schema:b||{},depth:0}},g});var fs=null,HTTPRequest=null,isNode=!1;typeof process!="undefined"&&process.versions&&process.versions.node&&(isNode=!0),define("deep/deep-request",["require","./utils","./promise","./deep-query"],function(require){function removeLoadInfo(a){loadInfo.paths[a]--,loadInfo.currentNumberOfLoad--,loadInfo.paths[a]==0&&delete loadInfo.paths[a],DeepRequest.handlers.loaded(a),loadInfo.currentNumberOfLoad==0&&DeepRequest.handlers.complete()}function addLoadInfo(a){loadInfo.callCount++,typeof loadInfo.paths[a]=="undefined"?loadInfo.paths[a]=1:loadInfo.paths[a]++,loadInfo.currentNumberOfLoad++,DeepRequest.handlers.added(a)}function manageEndOfRetrieve(a,b){return b}function createHTTPRequestParser(a,b,c){var d={status:b.status,body:"",__isRemoteResponse__:!0},e=promise.Deferred();return promise.when(b.body.join("")).then(function(a){if(typeof a=="string")if(c)a=c(a);else{var b=null;try{b=JSON.parse(a)}catch(f){b=null}b&&(a=b)}d.body=a,e.resolve(d.body)},function(a){console.log("createHTTPRequestParser : body.join error : ",resolved),e.reject(a)}),promise.promise(e)}var loadInfo={currentNumberOfLoad:0,paths:{},totalLoaded:0,totalToLoad:0,callCount:0},reloadablesUriDico={},reloadablesRegExpDico=[/^(json::)/gi],manageCache=function(a,b){if(reloadablesUriDico[b])return;var c=0;reg=reloadablesRegExpDico[c];while(reg&&!b.match(reg))reg=reloadablesRegExpDico[++c];c==reloadablesRegExpDico.length&&(cache[b]=a)},cache={},utils=require("./utils"),promise=require("./promise"),Querier=require("./deep-query"),DeepRequest={reloadables:function(a,b){typeof b=="undefined"&&(b=!0);if(b)a instanceof RegExp?reloadablesRegExpDico.push(a):reloadablesUriDico[a]=!0;else if(a instanceof RegExp){var c=0,d=!0,e=reloadablesRegExpDico.length;while(c<e&&d)a.toString()===reloadablesRegExpDico[c].toString()&&(c==e-1?reloadablesRegExpDico.pop():reloadablesRegExpDico[c]=reloadablesRegExpDico.pop(),d=!1),c++}else reloadablesUriDico[a]=!1},clearCache:function(){cache={}},lexic:{protocoles:{json:{headers:{Accept:"application/json; charset=utf-8;"},options:{queriable:!0,callable:!1},extensions:["json"],parsers:{nodeHttpRequest:function(a){if(typeof a=="string")if(parser)a=parser(a);else{var b=null;try{b=JSON.parse(a)}catch(c){b=null}b&&(a=b)}return a},"default":function(a){return typeof a=="string"&&(a=JSON.parse(a)),a},nodeFS:function(a,b){return b=b||"utf-8",JSON.parse(a.toString(b))}}},"json.range":{backgrounds:["#../json"],get:function(a,b){return DeepRequest.getRange()}},swig:{extensions:["html","swig","htm","xhtml"],get:function(a,b){return DeepRequest.html(a)}},"swig.macros":{parser:function(a,b){}},"jquery.htmlOf":{get:function(a,b){return function(a){return $(b).empty(),$(a).appendTo(b)}}},"jquery.appendTo":{get:function(a,b){return function(a){return $(a).appendTo(b)}}},"jquery.prependTo":{get:function(a,b){return function(a){return $(a).prependTo(b)}}}}}};DeepRequest.loadInfo=loadInfo,DeepRequest.handlers={loaded:function(a){},complete:function(){},added:function(a){}},DeepRequest.get2=function(a,b,c){var d=promise.Deferred();c=c||{},typeof a=="string"&&(a=DeepRequest.parse(a)),a.protocole||(a.protocole="json");var e=DeepRequest.lexic.protocoles[a.protocole]||{},f=e.parsers||{};return!a.uri&&a.query?(data=Querier.query(b.callerRoot,a.query,b.callerPath),f["default"]?data=f["default"](data):data=DeepRequest.lexic.protocoles.json.parsers["default"](data),manageEndOfRetrieve(a,data)):(a.body&&typeof a.body!="string"&&(a.body=JSON.stringify(a.body)),deepCopy(e[a.protocole].headers||{},c,!1),copyDefaultHeaders(c),c.Accept=c.Accept||"application/json;charset=utf-8",isNode?/http(s)?:\/\//.test(path)?HTTPRequest({method:"GET",url:a.uri,headers:options.headers}).then(function(a){createHTTPRequestParser("GET",a,f.nodeHttpRequest).then(function(a){d.resolve(a)})},function(){var a=Array.prototype.slice.call(arguments);d.reject(a)}):promise.when(fs.readFile(a.uri,options.charset)).then(function(a){f.nodeFS?a=f.nodeFS(a):a=JSON.parse(a.toString(options.charset)),query&&(a=Querier.query(a,query,{keepCache:!1})),d.resolve(a)},function(){var a=Array.prototype.slice.call(arguments);console.log("DeepRequest.json failed : "+JSON.stringify(a)),d.reject({msg:"DeepRequest.json failed : "+path,details:a,uri:path,options:options})}):promise.when($.ajax({beforeSend:function(a){writeJQueryHeaders(a,c)},url:a.uri,method:"GET",datatype:"json"})).then(function(a,b,c){f["default"]?a=f["default"](a):typeof a=="string"&&(a=JSON.parse(a)),query&&(a=Querier.query(a,query,{keepCache:!1})),d.resolve(a)},function(){var a=Array.prototype.slice.call(arguments);d.reject({msg:"DeepRequest.get failed : "+path,details:a,uri:path,options:options})}),promise.promise(d))},DeepRequest.setDefaultHeaders=function(a){this.defaultHeaders=a};var writeJQueryDefaultHeaders=function(a){if(DeepRequest.defaultHeaders)for(var b in DeepRequest.defaultHeaders)a.setRequestHeader(b,DeepRequest.defaultHeaders[b])},writeJQueryHeaders=function(a,b){if(b)for(var c in b)a.setRequestHeader(c,b[c])},copyDefaultHeaders=function(a){DeepRequest.defaultHeaders&&deepCopy(DeepRequest.defaultHeaders,a,!1)};return DeepRequest.exec=function(a,b,c){var d=a;typeof d=="string"&&(d=DeepRequest.parse(d));if(!d.uri&&d.query)var e=Querier.query(b.callerRoot,d.query,b.callerPath);var f=DeepRequest.lexic.protocole[a.protocole];if(!f)return a;var g=promise.Deferred();return f.get?promise.when(f.get(d,c)).then(function(a){},function(a){g.reject(a)}):promise.when(DeepRequest.get2(d,c)).then(function(a){},function(a){g.reject(a)}),promise.promise(g)},DeepRequest.parse=function(a){var b={type:null,request:a,uri:null,protocole:null,protocoleArguments:null,query:null,body:null,toCall:null,extension:null};if(typeof a=="undefined")return b.protocole=b.type="function",b.uri=a,b;if(typeof a!="string")return b.uri=a,b;var c=a,d=c.indexOf("::");if(d>-1){var e=c.substring(0,d);c=a.substring(d+2);var f=e.match(/([-a-z0-9_\.]+)|(\([^\)]+\))/gi);b.protocole=b.type=f.shift();if(f.length>0){b.protocoleArguments=[];var g=f.shift();g=g.substring(1,g.length-1),g=g.split(","),g.forEach(function(a){a[0]=="'"||a[0]=='"'?a=a.substring(1,a.length-1):a=parseFloat(a),b.protocoleArguments.push(a)})}}b.uri=null;var f=c.match(/([^#@§]+)|(§.+)|(@[^§]+)|(#[^@§]+)/gi);f.forEach(function(a){switch(a[0]){case"#":b.query=a.substring(1);break;case"@":b.toCall=a.substring(1);break;case"§":b.body=a.substring(1);break;default:b.uri=a;var c=a.substring(a.length-Math.min(6,a.length)),d=c.indexOf(".");d>-1&&(b.extension=c.substring(d+1)),b.extension&&!b.protocole&&(b.protocole=b.type=b.extension)}});switch(b.protocole){case"first":b.subquery="first";break;case"last":b.subquery="last";break;case"index":b.subquery="index"}return b.query&&!b.uri&&(b.type=b.protocole="queryThis"),b},DeepRequest.retrieveAll=function(a,b){if(typeof a.push!="function")return null;var c=[];return a.forEach(function(a){c.push(DeepRequest.retrieve(a,b))}),promise.all(c)},DeepRequest.retrieve=function(uri,options){options=options||{};var queryBasePath=options.basePath||null,othis=options.root||function(){},info=DeepRequest.parse(uri);console.flags["deep-request"]&&console.log("deep-request","retrieve : ",info," -   from : "+uri);if(info.protocole=="queryThis"&&!options.acceptQueryThis)throw new Error("you couldn't use queryThis protocole in that case");if(cache[uri])return cache[uri];switch(info.type){case"json":return info.range?DeepRequest.retrieveRange(info):DeepRequest.json(info.uri,info.query,othis);case"xml":return DeepRequest.xml(info.uri);case"text":return DeepRequest.text(info);case"html":return DeepRequest.html(info);case"swig":var defs=promise.Deferred();return DeepRequest.html(info.uri).then(function(a){var b=swig.compile(a,{filename:utils.stripFirstSlash(info.uri)});delete cache[info.uri],manageCache(b,info.request),defs.resolve(b)},function(){var a=Array.prototype.slice.call(arguments);defs.reject({emiter:"deep-request",msg:"retrieve swig failed for path : "+info.uri,details:a,basePath:uri})}),promise.promise(defs);case"js":if(info.query){var def=promise.Deferred();return promise.when(require(info.uri)).then(function(a){var b=Querier.query(a,info.query,{keepCache:!1});def.resolve(b)},function(a){def.reject(a)}),promise.promise(def)}return promise.when(require(info.uri));case"aspect":var def=promise.Deferred();return promise.when(require(info.uri)).then(function(a){def.resolve(a.aspect)},function(a){def.reject(a)}),promise.promise(def);case"instance":var cl=require(info.uri);if(typeof cl=="function"&&cl.prototype)return new cl;throw console.log("DeepRequest : could not instanciate : "+JSON.stringify(info)),new Error("DeepRequest : could not instanciate : "+JSON.stringify(info));case"eval":return eval(info.uri);case"func":return new Function(info.uri);case"function":if(options.callFunctions)return info.uri();return info.uri;case"dummies":return DeepRequest.json(info.uri,info.query,othis);case"queryThis":var res=null;if(othis._isDQ_NODE_)res=Querier.query(othis,info.query,{keepCache:!1});else{queryBasePath=queryBasePath||"";var q=info.query;res=Querier.query(othis,info.query,{keepCache:!1})}if(res)switch(info.subquery){case"first":res=res[0]||null;break;case"last":res=res[res.length-1]||null;break;case"index":info.protocoleArguments&&(res=res[+info.protocoleArguments[0]]||null);break;default:}return res;default:if(!info.protocole&&!info.uri&&info.query){if(!options.acceptQueryThis)throw new Error("you couldn't use queryThis protocole in that case");var res=null;if(othis._isDQ_NODE_)res=Querier.query(othis,info.query,{keepCache:!1});else{queryBasePath=queryBasePath||"";var q=info.query;res=Querier.query(othis,info.query,{keepCache:!1})}return res}return uri}return null},DeepRequest.jsons=function(a,b,c){var d=promise.Deferred(),e=new Array;return a.forEach(function(a){e.push(DeepRequest.json(a))}),promise.all(e).then(function(c){var e=[],f=0;b?c.forEach(function(c){var d=Querier.query(d,b,{keepCache:!1});d&&d.length>0&&e.push(d),manageCache(d,a[f++])}):e=c,d.resolve(e)},function(a){d.reject(("DeepRequest.jsons faileds : ",a))}),promise.promise(d)},DeepRequest.json=function(a,b,c){var d=null,e=null;if(typeof a=="object"){var f=a;a=f.uri,e=f.query,d=f.body}typeof d!="string"&&(d=JSON.stringify(d));var g=promise.Deferred();if(isNode)if(/http(s)?:\/\//.test(a))HTTPRequest({method:"GET",url:a,headers:{Accept:"application/json;charset=utf-8;"}}).then(function(a){createHTTPRequestParser("GET",a).then(function(a){console.log("DeepRequest.json : HTTP Request result : ",a),g.resolve(a)})},function(){var a=Array.prototype.slice.call(arguments);g.reject(a)});else{function h(a){if(DeepRequest.autobahn){var b=DeepRequest.autobahn.compileRoles(["public"]);promise.when(b).then(function(b){var c=a.split("/"),d=c[1],f=c[2];if(b.facets[d]){var h="get";if(!f||f=="")h="query";promise.when(b.facets[d][h](f)).then(function(a){e&&(a=Querier.query(a.toString(),e,{keepCache:!1})),g.resolve(a)},function(b){var c=Array.prototype.slice.call(arguments);g.reject({msg:"DeepRequest.json failed : "+a,details:c,uri:a})})}else DeepRequest.autobahn.getFile(a,"json").then(function(a){typeof a=="string"&&(a=JSON.parse(a.toString("utf-8"))),e&&(a=Querier.query(a.toString(),e,{keepCache:!1})),g.resolve(a)},function(){var b=Array.prototype.slice.call(arguments);console.log("DeepRequest.json failed : "+JSON.stringify(b)),g.reject({msg:"DeepRequest.json failed : "+a,details:b,uri:a})})})}else DeepRequest.autobahn.getFile(a,"json").then(function(a){typeof a=="string"&&(a=JSON.parse(a.toString("utf-8"))),e&&(a=Querier.query(a.toString(),e,{keepCache:!1})),g.resolve(a)},function(){var b=Array.prototype.slice.call(arguments);console.log("DeepRequest.json failed : "+JSON.stringify(b)),g.reject({msg:"DeepRequest.json failed : "+a,details:b,uri:a})})}h(a)}else $.ajaxSetup({jsonp:null,jsonpCallback:null}),promise.when($.ajax({beforeSend:function(a){writeJQueryDefaultHeaders(a),a.setRequestHeader("Accept","application/json; charset=utf-8")},contentType:"application/json; charset=utf-8",url:a,method:"GET",datatype:"json"})).done(function(b,c,d){typeof b=="string"&&(b=JSON.parse(b)),e&&(b=Querier.query(b,e,{keepCache:!1})),manageCache(b,a),g.resolve(b)}).fail(function(){var b=Array.prototype.slice.call(arguments);console.log("deep.request.json error : ",arguments),g.reject(new Error("DeepRequest.json failed : "+a+" - \n\n"+JSON.stringify(b)))});return promise.promise(g)},DeepRequest.html=function(a){var b=null,c=null;if(typeof a=="object"){var d=a;a=d.uri,c=d.query,b=d.body}var e=promise.Deferred();return isNode?/http(s)?:\/\//.test(a)?HTTPRequest({method:"GET",url:a,headers:{Accept:"application/json;charset=utf-8;"}}).then(function(a){createHTTPRequestParser("GET",a).then(function(a){e.resolve(a)})},function(){var a=Array.prototype.slice.call(arguments);e.reject(a)}):DeepRequest.autobahn.getFile(a,"html").then(function(a){e.resolve(a)},function(){var b=Array.prototype.slice.call(arguments);console.log("DeepRequest.html failed : "+JSON.stringify(b)),e.reject({msg:"DeepRequest.json failed : "+a,details:b,uri:a})}):$.when($.ajax({beforeSend:function(a){a.setRequestHeader("Accept","text/plain; charset=utf-8")},contentType:"text/plain; charset=utf-8",url:a,method:"get",datatype:"html"})).then(function(b,c,d){manageCache(b,a),e.resolve(b)},function(a){e.reject("DeepRequest.html failed : "+JSON.stringify(a))}),promise.promise(e)},DeepRequest.xml=function(a){var b=null,c=null;if(typeof a=="object"){var d=a;a=d.uri,c=d.query,b=d.body}var e=promise.Deferred();return isNode?promise.when(fs.readFile(a,"utf-8")).then(function(a){e.resolve(a.toString())},function(a){var b=Array.prototype.slice.call(arguments);console.log("DeepRequest.xml failed : "+JSON.stringify(b)),e.reject({msg:"deep-request : xml load failed ",arguments:b})}):promise.when($.ajax({beforeSend:function(a){a.setRequestHeader("Accept","application/xml")},contentType:"aplication/xml; charset=utf-8",url:a,method:"get",datatype:"xml"})).then(function(b){b=jQuery.parseXML(b),manageCache(b,a),e.resolve(b)},function(a){var b=Array.prototype.slice.call(arguments);console.log("DeepRequest.xml failed : "+JSON.stringify(b)),e.reject({msg:"deep-request : xml load failed ",arguments:b})}),promise.promise(e)},DeepRequest.rss=function(a){var b=promise.Deferred(),c=(document.location.protocol||"http:")+"//ajax.googleapis.com/ajax/services/feed/load?v=1.0&num=10&callback=?&q="+encodeURIComponent(a);addLoadInfo(a);var d=function(c){var d=null;if(c.responseData){d=c.responseData.feed,manageCache(d,a),b.resolve(d);return}b.reject({msg:"deep-request : rss load failed "+a,arguments:arguments})};return $.getJSON(c).then(function(b,c,e){removeLoadInfo(a),d(b)},function(c,d,e){removeLoadInfo(a),jqWHR.status<400&&console.log("WARNING : error but success with jquery/rss google : ",e),b.reject({msg:"deep-request : rss load failed "+a,arguments:arguments})}),promise.promise(b)},DeepRequest.text=function(a){return DeepRequest.get(a,{accept:"text/plain;charset=utf-8;"})},DeepRequest.get=DeepRequest.retrieve,DeepRequest.put=function(a,b){var c=DeepRequest.parse(a),d=promise.Deferred();return $.ajax({type:"PUT",beforeSend:function(a){writeJQueryDefaultHeaders(a),a.setRequestHeader("Accept","application/json; charset=utf-8")},url:c.uri,dataType:"application/json",contentType:"application/json; charset=utf-8",data:JSON.stringify(b)}).then(function(a){console.log("DeepRequest.put : success : ",a),d.resolve(a)},function(a,b,e){var f=$.parseJSON(a.responseText);if(a.status<300)console.log("DeepRequest.put : error but status 2xx : ",f," - status provided : "+a.status),typeof f=="string"&&(f=$.parseJSON(f)),d.resolve(f);else{var g=Array.prototype.slice.call(arguments);console.log("DeepRequest.put : failed (status > 2xx) : ",f," - status provided : ",a.status),d.reject({msg:"DeepRequest.put failed : "+c.request,status:a.status,details:g,uri:c.uri})}}),promise.promise(d)},DeepRequest.rpc=function(a,b,c){var d="call"+(new Date).valueOf(),e=promise.Deferred();return $.ajax({beforeSend:function(a){writeJQueryDefaultHeaders(a),a.setRequestHeader("Accept","application/json; charset=utf-8;")},type:"POST",url:a,dataType:"application/json-rpc; charset=utf-8;",contentType:"application/json-rpc; charset=utf-8;",data:JSON.stringify({id:d,method:b,params:c||[]})}).then(function(a){console.log("DeepRequest.rpc : success : ",a),e.resolve(a)},function(b,c,d){var f=$.parseJSON(b.responseText);if(b.status<300)typeof f=="string"&&(f=$.parseJSON(f)),e.resolve(f);else{var g=Array.prototype.slice.call(arguments);e.reject({msg:"DeepRequest.post failed : "+a,status:b.status,details:g,uri:a})}}),promise.promise(e)},DeepRequest.post=function(a,b){var c=DeepRequest.parse(a),d=promise.Deferred();return $.ajax({beforeSend:function(a){writeJQueryDefaultHeaders(a),a.setRequestHeader("Accept","application/json; charset=utf-8;")},type:"POST",url:c.uri,dataType:"application/json; charset=utf-8;",contentType:"application/json; charset=utf-8;",data:JSON.stringify(b)}).then(function(a){console.log("DeepRequest.post : success : ",a),d.resolve(a)},function(a,b,e){var f=$.parseJSON(a.responseText);if(a.status<300)typeof f=="string"&&(f=$.parseJSON(f)),d.resolve(f);else{var g=Array.prototype.slice.call(arguments);d.reject({msg:"DeepRequest.post failed : "+c.request,status:a.status,details:g,uri:c.uri})}}),promise.promise(d)},DeepRequest.patch=function(a,b){var c=DeepRequest.parse(a),d=promise.Deferred();return $.ajax({beforeSend:function(a){writeJQueryDefaultHeaders(a),a.setRequestHeader("Accept","application/json; charset=utf-8;")},type:"PATCH",url:c.uri,dataType:"application/json; charset=utf-8;",contentType:"application/json; charset=utf-8;",data:JSON.stringify(b)}).then(function(a){console.log("DeepRequest.patch : success : ",a),d.resolve(a)},function(a,b,e){var f=$.parseJSON(a.responseText);if(a.status<300)typeof f=="string"&&(f=$.parseJSON(f)),d.resolve(f);else{var g=Array.prototype.slice.call(arguments);d.reject({msg:"DeepRequest.patch failed : "+c.request,status:a.status,details:g,uri:c.uri})}}),promise.promise(d)},DeepRequest.deleteItems=function(a,b){var c=DeepRequest.parse(a);return typeof rql=="undefined"&&(rql=""),$.ajax({type:"POST",url:c.uri,dataType:"message/json",contentType:"application/json; charset=utf-8"})},DeepRequest.retrieveRange=function(a){function d(d,e){var f=[],g={},h=[];if(b.type=="dummies"){var i=a.range;e.push||(e=[e]),g.totalCount=e.length;if(i.end<=e.length){g.range=i.start+"-"+i.end;for(var j=0;j<e.length;j++)j>=i.start&&j<=i.end&&h.push(e[j])}else h=e,console.log("ERROR deep-request.retrieveRange range is higher then dummies array - giving all Array by default !! ")}else{var k=d.getResponseHeader("content-range");k=k.substring(6),k&&(f=k.split("/"));if(k&&f&&f.length>0){g.range=f[0];if(g.range=="0--1")g.totalCount=0,g.start=0,g.end=0;else{g.totalCount=parseInt(f[1]);var l=f[0].split("-");g.start=parseInt(l[0]),g.end=parseInt(l[1])}}else console.log("ERROR deep-request.retrieveRange range header missing !! ");h=e}c.resolve({results:h,range:g})}var b=a,c=promise.Deferred();return $.ajax({beforeSend:function(b){b.setRequestHeader("Accept","application/json; charset=utf-8"),b.setRequestHeader("range","items="+a.range.start+"-"+a.range.end)},type:"GET",url:a.uri,dataType:"application/json",contentType:"application/json; charset=utf-8"}).then(function(a,b,c){d(c,a)},function(a,b,e){var f=Array.prototype.slice.call(arguments);a.status==200||a.status==206?d(a,JSON.parse(a.responseText)):c.reject(f)}),promise.promise(c)},DeepRequest.crossDomainXML=function(a,b){var c=promise.Deferred(),d="http://query.yahooapis.com/v1/public/yql?q="+encodeURIComponent('select * from xml where url="'+a+'"')+"&format=xml&callback=?";return $.getJSON(d).then(function(a){var d=Array.prototype.slice.call(arguments);if(a.results[0]){var e=null;switch(b){case"xml":e=$.parseXML(a.results);break;case"rss":e=new JFeed($.parseXML(a.results));break;default:c.reject({msg:"deep-request : cross domain xml load failed : bad type provided : "+b,arguments:d})}manageCache(e,path),c.resolve(e)}else c.reject({msg:"deep-request : cross domain xml load failed ",arguments:d})},function(){var a=Array.prototype.slice.call(arguments);c.reject({msg:"deep-request : cross domain xml load failed ",arguments:a})}),promise.promise(c)},DeepRequest}),define("deep/deep",["require","./ie-hacks","./utils","./deep-rql","./deep-request","./deep-schema","./promise","./deep-query","./deep-compose"],function(a){function i(a,b,c){typeof c=="undefined"?c=[]:c instanceof Array||(c=[c]);var d;return a.value&&a.value[b]?(a.value._deep_entry=a,d=a.value[b].apply(a.value,c),d&&d.then?d.then(function(){delete a.value._deep_entry},function(){delete a.value._deep_entry}):delete a.value._deep_entry,d):d}function j(a,b,c){typeof c=="undefined"?c=[]:c instanceof Array||(c=[c]),a.value._deep_entry=a;var d=b.apply(a.value,c);return d&&d.then?d.then(function(){delete a.value._deep_entry},function(){delete a.value._deep_entry}):delete a.value._deep_entry,d}function k(a,b){if(this.running||this.rejected)return;this.running=!0;var c=this;a instanceof Error&&(this.reports.failure=b=a,this.reports.result=a=null),typeof b!="undefined"&&b!==null||typeof a!="undefined"&&a!==null?(this.reports.failure=b,this.reports.result=a):(b=this.reports.failure,a=this.reports.result),this.oldQueue&&(this.callQueue=this.callQueue.concat(this.oldQueue),delete this.oldQueue);if(this.callQueue.length>0){var d=this.callQueue.shift(),e=null,f=deep.context;try{f!==this.context&&(f&&f.suspend&&f.suspend(),deep.context=this.context,this.context&&this.context.resume&&this.context.resume()),b?d._isTHEN_||d._isTRANSPARENT_||d._isPUSH_HANDLER_TO_?d(a,b):this.rejected||this.reject(b):typeof d=="object"?d.func(a,b):d(a,b)}catch(g){var h="Internal chain error : rethorw ? "+c.rethrow;console.error(h,g);if(c.rethrow)throw g;setTimeout(function(){c.running=!1,k.apply(c,[null,g])},1)}finally{f!==this.context&&(this.context&&this.context.suspend&&this.context.suspend(),f&&f.resume&&f.resume(),deep.context=f)}}else this.running=!1,b&&!this.rejected&&(this.waitingRejection?this.reject(b):(this.waitingRejection=!0,setTimeout(function(){c.running=!1,k.apply(c,[a,b])},1)))}function l(a,b,c){a.running=!1,k.apply(a,[b,c])}function m(a){var b=this.callQueue[this.callQueue.length-1];a._isPUSH_HANDLER_TO_&&!this.initialised?a():this.callQueue.push(a),this.running||k.apply(this)}function n(a,b){var c=[];b&&(c=c.concat(a._nodes));var d=new o({_entries:c,result:a.reports.result,failure:a.reports.failure});return d}function r(a,b){if(this.running)return;this.running=!0;var c=this;typeof b!="undefined"&&b!==null||typeof a!="undefined"&&a!==null?(this.failure=b,this.result=a):(b=this.failure,a=this.result),a instanceof Error&&(this.failure=b=a,this.result=a=null);if(this.queue.length>0){var d=deep.context;try{d!==this.context&&(d&&d.suspend&&d.suspend(),deep.context=this.context,this.context&&this.context.resume&&this.context.resume());var e=this.queue.shift();e(a,b)}catch(f){var g="Internal deep.promise error : ";console.error(g,f);if(deep.rethrow)throw f;setTimeout(function(){c.running=!1,r.apply(c,[null,f])},1)}finally{d!==this.context&&(this.context&&this.context.suspend&&this.context.suspend(),d&&d.resume&&d.resume(),deep.context=d)}}else this.running=!1}function t(a){var b=new q;return b.running=!1,a instanceof Error?(b.rejected=!0,b.failure=a):(b.resolved=!0,b.result=a),b}console.warn||(console.warn=console.log),console.error||(console.error=console.log),console.info||(console.info=console.log);var b=a("./deep-schema"),c=a("./deep-request"),d=a("./utils"),f=a("./promise"),g=a("./deep-query"),h=a("./deep-compose");deep=function(a,b,c){var d=[];a instanceof Array?d.push(deep.all(a)):typeof a=="string"?d.push(deep.get(a)):d.push(a),typeof b=="string"?d.push(deep.get(b)):b&&d.push(b);var e=new o(c);return e.running=!0,deep.all(d).done(function(c){a=c.shift(),b&&(b=c.shift()),e.initialised=!0;if(a instanceof Array)return e._nodes=[],a.forEach(function(a){e._nodes.push(g.createRootNode(a,b))}),l(e,deep.chain.values(e),null);a instanceof o?e._nodes=[].concat(a._nodes):typeof a=="object"&&a._isDQ_NODE_?e._nodes=[a]:typeof a=="object"&&a._deep_entry?e._nodes=[a._deep_entry]:e._nodes=[g.createRootNode(a,b)],e._nodes.length>1?l(e,deep.chain.values(e),null):l(e,deep.chain.val(e),null)}).fail(function(a){l(e,null,a)}),e},deep.rethrow=!0,deep.metaSchema={},deep.request=c,deep.utils=d,deep.validate=b.validate,deep.partialValidation=b.partialValidation,deep.compose=h,deep.metaSchema={},deep.isNode=typeof process!="undefined"&&process.versions&&process.versions.node,deep.rql=a("./deep-rql"),deep.query=g.query,deep.collider=a("./deep-collider"),deep.Querier=g,deep.interpret=d.interpret,deep.context=null;var o=function(a){this.rethrow=deep.rethrow,this.positions=[],this.context=deep.context,a=a||{},this.querier=new g,this.callQueue=[],this._nodes=a._nodes||[],this.queries=[],this.deferred=deep.Deferred(),this.rejected=!1,this.reports={result:a.result||null,failure:a.failure||null}};deep.Handler=o,o.prototype={querier:null,synch:!0,_entries:null,callQueue:null,reports:null,queries:null,brancher:function(){var a=this,b={branch:function(){this.branches||(this.branches=[]);var b=n(a,!0);return this.branches.push(b),l(b,a.reports.result,a.reports.failure),b},_isBRANCHES_:!0};return b},reverse:function(){var a=this,b=function(b,c){a._nodes.reverse(),a.running=!1,k.apply(a,[a._nodes,null])};return m.apply(this,[b]),a},catchError:function(a){var b=this;typeof a=="undefined"&&(a=!0);var c=function(c,d){b.rethrow=!a,b.running=!1,k.apply(b,[c,d])};return c._isTRANSPARENT_=!0,m.apply(this,[c]),b},cancel:function(a){if(this.rejected)throw new Error("deep chain could not be canceled : it has already been rejected! ");var b=this.callQueue;this.callQueue=[],this.reports.cancel=a,this.deferred.cancel(a)},reject:function(a){if(this.rejected)throw new Error("deep chain has already been rejected! ");this.reports.failure=a,this.rejected=!0,this.callQueue=[],this.deferred.reject(a)},branches:function(a){var b=this,c=function(c,d){deep.when(a(n(b,!0).brancher())).then(function(a){b.running=!1,k.apply(b,[a,null])},function(a){b.running=!1,k.apply(b,[null,a])})};return m.apply(this,[c]),b},when:function(a){function c(){return function(c,d){deep.when(a).then(function(a){typeof a=="undefined"&&(a=c),b.running=!1,k.apply(b,[a,null])},function(a){b.running=!1,k.apply(b,[null,a])})}}var b=this;return m.apply(this,[c()]),this},done:function(a){var b=this,c=function(c,d){if(d||!a||c instanceof Error){l(b,c,d);return}b.oldQueue=b.callQueue,b.callQueue=[],deep.when(a(c,b,b.brancher())).then(function(a){var d=null;typeof a=="undefined"?a=c:a instanceof Error&&(d=a,a=null),b.callQueue=b.callQueue.concat(b.oldQueue),delete b.oldQueue,l(b,a,d)},function(a){b.callQueue=b.callQueue.concat(b.oldQueue),delete b.oldQueue,l(b,null,a)})};return c._isTHEN_=!0,m.apply(this,[c]),b},fail:function(a){var b=this,c=function(c,d){if(d===null||typeof d=="undefined"||!a){l(b,c,d);return}b.oldQueue=b.callQueue,b.callQueue=[],deep.when(a(d,b,b.brancher())).then(function(a){b.callQueue=b.callQueue.concat(b.oldQueue),delete b.oldQueue,typeof a=="undefined"?l(b,null,d):a instanceof Error?l(b,null,a):l(b,a,null)},function(a){b.callQueue=b.callQueue.concat(b.oldQueue),delete b.oldQueue,l(b,null,a)})};return c._isTHEN_=!0,m.apply(this,[c]),b},then:function(a,b){return a&&this.done(a),b&&this.fail(b),this},range:function(a,b){var c=this,e=function(e,f){var g=null;typeof a=="object"?g=d.createStepWidthRangeObject(a.step,a.width,c._nodes.length):g=d.createStartEndRangeObject(a,b,c._nodes.length),c._nodes=c._nodes.slice(g.start,g.end+1),g.results=deep.chain.values(c),l(c,g,null)};return m.apply(this,[e]),this},position:function(a,b){var c=this,d=function(d,e){deep.chain.position(c,a,b),c.running=!1,k.apply(c,[d,e])};return m.apply(this,[d]),this},back:function(a,b){var c=this,d=function(d,e){var f=null;if(a){var g=c.positions.concat([]),h=!1;while(g.length>0){f=g.pop();if(f.name==a){h=!0;break}}g.length===0&&!h&&(f=null)}else f=c.positions[c.position.length-1];if(!f)throw new Error("chain handler error : no positions to go back with name : "+a);c._nodes=f.entries,c._store=f.store;if(f.restartChain||b&&b.restartChain)c.callQueue=f.queue;c.running=!1,k.apply(c,[c._nodes,null])};return m.apply(this,[d]),this},first:function(){var a=this,b=function(){a._nodes=[a._nodes[0]],a.running=!1,k.apply(a,[a._nodes])};return m.apply(this,[b]),this},last:function(){var a=this,b=function(){a._nodes=[a._nodes[a._nodes.length-1]],a.running=!1,k.apply(a,[a._nodes])};return m.apply(this,[b]),this},parents:function(a){var b=this,c=function(){var c=[];b._nodes.forEach(function(a){c.push(a.ancestor)}),c=deep.utils.arrayUnique(c,"path"),b._nodes=c;if(c.length===0&&a)throw new Error("deep.parents could not gives empty results");b.running=!1,k.apply(b,[b._nodes,null])};return m.apply(this,[c]),b},root:function(a,b){var c=this,d=function(){deep(a,b).nodes(function(a){c._nodes=a}).done(function(a){l(c,a,null)})};return m.apply(this,[d]),this},query:function(a,b){var c=this;c.queries.push(a),a instanceof Array||(a=[a]);var d=function(){var d=[];c._nodes.forEach(function(b){a.forEach(function(a){d=d.concat(c.querier.query(b,a,{resultType:"full"}))})}),c._nodes=d;if(d.length===0&&b)throw new Error("deep.query could not gives empty results");c.running=!1,k.apply(c,[deep.chain.values(c),null])};return m.apply(c,[d]),c},select:function(a,b){var c=this;a instanceof Array||(a=[a]);var d=[];c._nodes.forEach(function(b){a.forEach(function(a){d=d.concat(c.querier.query(b,a,{resultType:"full"}))})});if(d.length===0&&b)throw new Error("deep.query could not gives empty results");var e=[];return d.forEach(function(a){e.push(a.value)}),e},schema:function(a){var b=this,c=function(){deep.when(deep.get(a)).then(function(a){var c=[];b._nodes.forEach(function(b){b.schema=a}),b.running=!1,k.apply(b,[a,null])}).fail(function(a){b.running=!1,k.apply(b,[null,a])})};return m.apply(this,[c]),this},schemaUp:function(a,b){b=b||deep.metaSchema||{};var c=this,e=function(){deep.when(deep.get(a)).done(function(a){var e=[];c._nodes.forEach(function(c){c.schema||(c.schema={}),e.push(d.up(a,c.schema,b))}),deep.all(e).then(function(a){c.running=!1,k.apply(c,[c._nodes,null])},function(a){throw console.error("error : deep.schemaUp : ",a),new Error("error : deep.schemaUp : "+a)})}).fail(function(a){c.running=!1,k.apply(c,[null,a])})};return m.apply(this,[e]),this},schemaBottom:function(a,b){b=b||deep.metaSchema||{};var c=this,e=function(){deep.when(deep.get(a)).done(function(a){var e=[];c._nodes.forEach(function(c){c.schema||(c.schema={}),e.push(d.bottom(a,c.schema,b))}),deep.all(e).then(function(a){c.running=!1,k.apply(c,[c._nodes,null])},function(a){throw console.error("error : deep.schemaBottom : ",a),new Error("error : deep.schemaBottom : "+a)})}).fail(function(a){c.running=!1,k.apply(c,[null,a])})};return m.apply(this,[e]),this},setByPath:function(a,b){var c=this,e=function(){deep.when(deep.get(b)).then(function(b){var e=[];c._nodes.forEach(function(c){e.push(d.setValueByPath(c.value,a,b,"/"))}),c.running=!1,k.apply(c,[e,null])},function(a){throw console.error("error : deep.setByPath : ",a),a instanceof Error?a:new Error("error : deep.setByPath : "+String(a))})};return m.apply(this,[e]),this},up:function(){var a=Array.prototype.slice.call(arguments),b=this,c=function(){deep.when(deep.getAll(a)).then(function(a){b._nodes.forEach(function(b){a.forEach(function(a){d.up(a,b.value,b.schema,b.ancestor?b.ancestor.value:null,b.key)})}),b.running=!1,k.apply(b,[b._nodes,null])},function(a){throw console.error("error : deep.up : ",a),new Error("error : deep.up : "+a)})};return m.apply(this,[c]),this},bottom:function(){var a=Array.prototype.slice.call(arguments);a.reverse();var b=this,c=function(){deep.when(deep.getAll(a)).then(function(a){b._nodes.forEach(function(b){a.forEach(function(a){d.bottom(a,b.value,b.schema,b.ancestor?b.ancestor.value:null,b.key)})}),b.running=!1,k.apply(b,[b._nodes,null])},function(a){throw new Error("error : deep.bottom : "+error)})};return m.apply(this,[c]),this},replace:function(a,b,c){var d=this,e=function(){deep.when(deep.get(b,c)).then(function(b){var c=[];d._nodes.forEach(function(e){d.querier.query(e,a,{resultType:"full"}).forEach(function(a){if(!a.ancestor)return;a.ancestor.value[a.key]=a.value=b,c.push(a)})}),d.running=!1,k.apply(d,[c,null])},function(a){throw new Error("error : deep.replace : "+error)})};return m.apply(this,[e]),this},remove:function(a){var b=this,c=function(){var c=[];b._nodes.forEach(function(d){b.querier.query(d,a,{resultType:"full"}).forEach(function(a){if(!a.ancestor)return;c.push(a),a.ancestor.value instanceof Array?a.ancestor.value.splice(a.key,1):delete a.ancestor.value[a.key]})}),b.running=!1,k.apply(b,[c,null])};return m.apply(this,[c]),this},extendsChilds:function(a){if(!a)return a;var b=this.querier.query(a,".//*?backgrounds",{resultType:"full"});if(b.length===0)return a;var c=deep.Deferred(),d=b[0],e=deep(d);return e.flatten().then(function(){deep.when(e.extendsChilds(a)).then(function(){c.resolve(a)},function(a){c.reject(a)})},function(a){c.reject(a)}),deep.promise(c)},extendsBackgrounds:function(a){var b=this,c=a;if(!a)return[];a._isDQ_NODE_&&(c=a.value);if(c.backgrounds){var d=deep.Deferred();return c.backgrounds.push||(c.backgrounds=[c.backgrounds]),deep.when(deep.getAll(c.backgrounds,{root:a})).then(function(e){var f=[];while(e.length>0){var g=e.shift();if(g instanceof Array){e=g.concat(e);continue}f.push(g),f.push(b.extendsBackgrounds(g))}deep.all(f).then(function(a){var b=[];a.forEach(function(a){b=b.concat(a)}),delete c.backgrounds,d.resolve(b)},function(a){console.error("currentLevel extension (backgrounds property) failed to retrieve pointed ressource(s) : "+JSON.stringify(e)),d.reject(a)})},function(a){console.error("currentLevel extension (backgrounds property) failed to retrieve pointed ressource(s) : "+JSON.stringify(extendeds)),d.reject(a)}),deep.promise(d)}return[]},flatten:function(){var a=this,b=0,c=function(c){deep.when(a.extendsChilds(c)).then(function(){b--,b===0&&(a.running=!1,k.apply(a,[deep.chain.values(a),null]))},function(a){throw console.error("error : deep.flatten : ",a),new Error("error : deep.flatten : "+a)})},e=function(){var e=[];a._nodes.forEach(function(e){b++,e.value.backgrounds?(deep.when(a.extendsBackgrounds(e)).then(function(a){var b={};a.forEach(function(a){b=d.bottom(a,e.value,e.schema),delete a.backgrounds}),delete e.value.backgrounds,c(e)},function(a){throw console.error("error : deep.flatten : ",a),new Error("error : deep.flatten : "+a)}),delete e.value.backgrounds):c(e)}),a._nodes.length===0&&(a.running=!1,k.apply(a,[deep.chain.values(a),null]))};return m.apply(this,[e]),this},run:function(a,b){var c=this;b=b||[];var d=function(d,e){var f=[];c._nodes.forEach(function(c){if(!a){if(typeof c.value!="function")return;c.ancestor?f.push(i(c.ancestor,c.key,b)):f.push(c.value(b||null));return}typeof a=="function"?f.push(j(c,a,b)):typeof a=="string"?f.push(i(c,a,b)):f.push(c)}),deep.all(f).then(function(a){c.running=!1,k.apply(c,[a,null])},function(a){console.error("error : deep.run : ",a),c.running=!1,k.apply(c,[null,a])})};return m.apply(this,[d]),this},exec:function(a,b){var c=this;b=b||[];var d=function(){deep.when(a.apply({},b)).then(function(a){c.running=!1,k.apply(c,[a,null])},function(a){console.error("error : deep.exec : ",a),c.running=!1,k.apply(c,[null,a])})};return m.apply(this,[d]),this},valuesEqual:function(a,b){var c=this,e=function(){var e=deep.chain.values(c),f={equal:d.deepEqual(e,a),needed:a,needLength:a.length,valuesLength:e.length,value:e};f.equal?console.info("deep.valuesEqual : "+JSON.stringify(f,null," ")):console.error("deep.valuesEqual : "+JSON.stringify(f,null," ")),b?deep.when(b(f)).then(function(a){typeof a=="undefined"&&(a=f),c.running=!1,k.apply(c,[a,null])},function(a){c.running=!1,k.apply(c,[f,a])}):(c.running=!1,k.apply(c,[f,!f.equal]))};return m.apply(this,[e]),c},equal:function(a,b){var c=this,e=function(){var e=[],f=[];c._nodes.forEach(function(b){var c=d.deepEqual(b.value,a),g={path:b.path,equal:c,value:b.value,needed:a};e.push(g),c||f.push(g),g.equal?console.info("deep.equal : "+g.equal+" : ",g):console.error("deep.equal : "+g.equal+" : ",g)});var g={equal:c._nodes.length>0&&f.length===0,reports:e};b?deep.when(b(g)).then(function(a){typeof a=="undefined"&&(a=g),c.running=!1,k.apply(c,[a,null])},function(a){c.running=!1,k.apply(c,[null,a])}):(f.length===0&&(f=null),c.running=!1,k.apply(c,[g,f]))};return m.apply(this,[e]),c},validate:function(a){a=a||{};var c=this,d=function(){var d=[];c._nodes.forEach(function(a){d.push(b.validate(a.value,a.schema))}),deep.all(d).then(function(b){var d={valid:!0,reports:b};b.forEach(function(a){if(a.valid)return;d.valid=!1}),a.callBack?deep.when(a.callBack(d)).then(function(a){typeof a=="undefined"&&(a=d),c.running=!1,k.apply(c,[a,null])},function(a){c.running=!1,k.apply(c,[d,a])}):(c.running=!1,k.apply(c,[null,d]))},function(a){c.running=!1,k.apply(c,[null,a])})};return m.apply(this,[d]),this},log:function(){var a=this,b=Array.prototype.slice.call(arguments),c=function(c,d){b.length===0&&(b.push("deep.log : "),d?(b.push("ERROR State : "),b.push(d)):(b.push("SUCCESS State : "),b.push(c))),b.forEach(function(a){console.log(a)}),a.running=!1,k.apply(a,[c,d])};return c._isTRANSPARENT_=!0,m.apply(this,[c]),this},logValues:function(a,b){var c=this;b=b||{};var d=function(d,e){console.log(a||"deep.logValues : "," ("+c._nodes.length+" values)"),c._nodes.forEach(function(a){var c=a,d=a.value._deep_entry;delete a.value._deep_entry,b.full||(c=a.value),b.pretty&&(c=JSON.stringify(c,null," ")),console.log("\t- entry : ("+a.path+") : ",c),d&&(a._deep_entry=d)}),c.running=!1,k.apply(c,[d,e])};return d._isTRANSPARENT_=!0,m.apply(this,[d]),this},val:function(a){var b=this,c=function(c,d){var e=b._nodes[0]?b._nodes[0].value:null;deep.when(a(e)).then(function(a){typeof a=="undefined"&&(a=e),b.running=!1,k.apply(b,[c,d])},function(a){console.error("error : deep.values : ",a),b.running=!1,k.apply(b,[null,a])})};return a?(m.apply(this,[c]),this):deep.chain.values(this).shift()},each:function(a){var b=this,c=function(){var c=[];b._nodes.forEach(function(b){c.push(a(b.value))}),deep.all(c).then(function(a){b.running=!1,k.apply(b,[a,null])},function(a){console.error("error : deep.each : ",a),b.running=!1,k.apply(b,[null,a])})};return m.apply(this,[c]),this},values:function(a){var b=this,c=function(c,d){var e=deep.chain.values(b);deep.when(a(e)).then(function(a){typeof a=="undefined"&&(a=e),b.running=!1,k.apply(b,[c,d])},function(a){console.error("error : deep.values : ",a),b.running=!1,k.apply(b,[null,a])})};return a?(m.apply(this,[c]),this):deep.chain.values(this)},nodes:function(a){var b=this,c=function(c,d){var e=b._nodes.concat([]);deep.when(a(e)).then(function(a){b.running=!1,k.apply(b,[c,d])},function(a){console.error("error : deep.nodes : ",a),b.running=!1,k.apply(b,[null,a])})};return a?(m.apply(this,[c]),this):deep.chain.nodes(this)},paths:function(a){var b=this,c=function(c,d){var e=deep.chain.paths(b);deep.when(a(e)).then(function(a){typeof a=="undefined"&&(a=e),b.running=!1,k.apply(b,[c,d])},function(a){console.error("error : deep.paths : ",a),b.running=!1,k.apply(b,[null,a])})};return a?(m.apply(this,[c]),this):deep.chain.paths(this)},schemas:function(a){var b=this,c=function(c,d){var e=deep.chain.schemas(b);deep.when(a(e)).then(function(a){typeof a=="undefined"&&(a=e),b.running=!1,k.apply(b,[c,d])},function(a){console.error("error : deep.schemas : ",a),b.running=!1,k.apply(b,[null,a])})};return a?(m.apply(this,[c]),this):deep.chain.schemas(this)},delay:function(a){function c(){return function(c,d){setTimeout(function(){console.log("deep.delay.end : ",a),b.running=!1,k.apply(b,[c,d])},a)}}var b=this;return c._isTRANSPARENT_=!0,m.apply(this,[c()]),this},deepLoad:function(a){function c(){return function(c,d){var e=[],f=[];b._nodes.forEach(function(c){var d=b.querier.query(c,".//*?or(_schema.type=string,_schema.type=function)",{resultType:"full"});d.forEach(function(b){if(typeof b.value=="string"){var c=b.value;a&&(c=deep.interpret(b.value,a)),f.push(deep.get(b.value,{root:b.root?b.root.value:b.value,basePath:b.path}))}else typeof b.value=="function"?f.push(b.value()):f.push(b.value);e.push(b)})}),deep.all(f).done(function(a){var c=0;a.forEach(function(a){var b=e[c++];b.ancestor&&(b.ancestor.value[b.key]=b.value=a)}),b.running=!1,k.apply(b,[a,null])}).fail(function(a){console.error("error : deep.deepLoad : ",a),b.running=!1,k.apply(b,[null,a])})}}var b=this;return m.apply(this,[c()]),this},load:function(a,b){function d(){return function(){var d=[],e=[];a?(typeof a=="string"&&(b&&(a=deep.interpret(a,b)),e.push(deep.get(a))),typeof a=="function"?e.push(a()):e.push(a)):c._nodes.forEach(function(a){if(!a.value)return;if(a.value.load)e.push(i(a,"load"));else if(typeof a.value=="string"){var c=a.value;b&&(c=deep.interpret(c,b)),e.push(deep.get(c,{root:a.root?a.root.value:a.value,basePath:a.path}))}else e.push(a.value);d.push(a)}),deep.all(e).then(function(b){var e=0;a?c._nodes.forEach(function(a){a.ancestor?a.value=a.ancestor.value[a.key]=b[0]:a.value=b[0]}):b.forEach(function(a){var b=d[e++];b.value.load||(b.ancestor?b.value=b.ancestor.value[b.key]=a:b.value=a)}),c.running=!1,k.apply(c,[b,null])},function(a){console.error("deep.load errors : ",a),c.running=!1,k.apply(c,[null,a])})}}var c=this;return m.apply(this,[d()]),this},deepInterpret:function(a){var b=this,c=function(){a=typeof a=="string"?deep.get(a):a,deep(a).done(function(a){var c=[];b._nodes.forEach(function(d){var e=b.querier.query(d,".//?_schema.type=string",{resultType:"full"});e.forEach(function(b){var d=deep.interpret(b.value,a);c.push(d),b.ancestor?b.ancestor.value[b.key]=b.value=d:b.value=d})}),b.running=!1,k.apply(b,[c,null])}).fail(function(a){console.error("error : deep.deepInterpret : ",a),b.running=!1,k.apply(b,[null,a])})};return m.apply(this,[c]),this},interpret:function(a){var b=this,c=function(){console.log("deep.chain.interpret : context : ",a),a=typeof a=="string"?deep.get(a):a,deep(a).then(function(a){console.log("interpret: received context : ",a);var c=[];b._nodes.forEach(function(b){if(typeof b.value=="string"){var d=deep.interpret(b.value,a);c.push(d),b.ancestor?b.ancestor.value[b.key]=b.value=d:b.value=d,console.log("deep.chain.interpret : res : ",d)}else c.push(b.value)}),b.running=!1,k.apply(b,[c,null])},function(a){console.error("error : deep.interpret : ",a),b.running=!1,k.apply(b,[null,a])})};return m.apply(this,[c]),this},pushHandlerTo:function(a){function c(){var c=function(c,d){a.push(b),b.initialised&&(b.running=!1,k.apply(b,[c,d]))};return c._isPUSH_HANDLER_TO_=!0,c}var b=this;return m.apply(this,[c()]),this},pushNodesTo:function(a){function c(){return function(c,d){var e=[];b._nodes.forEach(function(b){a.push(b),e.push(b)}),b.running=!1,k.apply(b,[c,d])}}var b=this;return m.apply(this,[c()]),this},pushValuesTo:function(a){function c(){return function(c,d){var e=[];b._nodes.forEach(function(b){a.push(b.value),e.push(b.value)}),b.running=!1,k.apply(b,[c,d])}}var b=this;return m.apply(this,[c()]),this},pushPathsTo:function(a){var b=this,c=function(c,d){var e=[];b._nodes.forEach(function(b){a.push(b.path),e.push(b.path)}),b.running=!1,k.apply(b,[c,d])};return m.apply(this,[c]),this},pushSchemasTo:function(a){var b=this,c=function(c,d){var e=[];b._nodes.forEach(function(b){a.push(b.schema),e.push(b.schema)}),b.running=!1,k.apply(b,[c,d])};return m.apply(this,[c]),this},rejectIf:function(a){function c(){return function(){typeof a=="function"?deep.when(a()).then(function(a){a?b.reject(a):(b.running=!1,k.apply(b,[a,null]))}):a?b.reject(a):(b.running=!1,k.apply(b,[a,null]))}}var b=this;return m.apply(this,[c()]),b},cancelIf:function(a){function c(){return function(){typeof a=="function"?deep.when(a()).then(function(a){a?b.cancel(a):(b.running=!1,k.apply(b,[a,null]))}):a?b.cancel(a):(b.running=!1,k.apply(b,[a,null]))}}var b=this;return m.apply(this,[c()]),b},treat:function(a){var b=this,c=function(c,d){var e=[];a?b._nodes.forEach(function(b){e.push(deep.applyTreatment.apply(a,[b.value]))}):b._nodes.forEach(function(b){typeof b.value.treat=="function"?e.push(b.value.treat(a)):e.push(b.value)}),deep.all(e).done(function(a){b.running=!1,deep.chain.nextQueueItem.apply(b,[a,null])})};return deep.chain.addInChain.apply(this,[c]),this},mapOn:function(a,b,c,d){var e=this,f=function(a,b,c,d){var f={};a.forEach(function(a){if(a===null)return;var b=a[c];typeof f[b]!="undefined"?f[b]instanceof Array?f[b].push(a):f[b]=[f[b],a]:f[b]=a}),e._nodes.forEach(function(a){f[a.value[b]]&&(a.value[d||b]=f[a.value[b]])}),l(e,deep.chain.values(e),null)},g=function(g,h){if(e._nodes.length===0){l(e,deep.chain.values(e),null);return}if(typeof a=="string"){var i=deep.parseRequest(a),j=n(e,!0),k=j.select("./"+b).join(","),m=c+"=in=("+k+")";i.uri.match(/\/\?/gi)?i.uri+="&"+m:i.uri+="?"+m,i.store!==null?deep(i.store.get(i.uri)).done(function(a){a=[].concat(a),f(a,b,c,d)}):l(e,null,new Error("deep.mapOn need array as 'what' : provided : "+JSON.stringify(a)))}else f(a,b,c,d)};return deep.chain.addInChain.apply(this,[g]),this}},deep.chain={nextQueueItem:k,addInChain:m,stringify:function(a,b){b=b||{};var c="";return a._nodes.forEach(function(a){b.pretty?c+=JSON.stringify(a.value,null," ")+"\n":c+=JSON.stringify(a.value)+"\n"}),c},val:function(a){return a._nodes.length===0?undefined:a._nodes[0].value},values:function(a){var b=[];return a._nodes.forEach(function(a){b.push(a.value)}),b},nodes:function(a){var b=[];return a._nodes.forEach(function(a){b.push(a)}),b},paths:function(a){var b=[];return a._nodes.forEach(function(a){b.push(a.paths)}),b},schemas:function(a){var b=[];return a._nodes.forEach(function(a){b.push(a.schema)}),b}},deep.chain.position=function(a,b){a.positions.push({name:b,entries:a._nodes.concat([]),store:a._store,queue:a.callQueue.concat([])})};var p=function(){this.context=deep.context,this.running=!0,this.queue=[],this.promise=new q(this)};p.prototype={context:null,promise:null,rejected:!1,resolved:!1,canceled:!1,result:null,failure:null,resolve:function(a){if(this.rejected||this.resolved||this.canceled)throw new Error("DeepDeferred (resolve) has already been resolved !");this.promise.result=this.result=a,this.promise.running=!1,a instanceof Error?(this.rejected=this.promise.rejected=!0,r.apply(this.promise,[null,a])):(this.resolved=this.promise.resolved=!0,r.apply(this.promise,[a,null]))},reject:function(a){if(this.rejected||this.resolved||this.canceled)throw new Error("DeepDeferred (reject) has already been rejected !");this.promise.failure=this.failure=a,this.rejected=this.promise.rejected=!0,this.promise.running=!1,r.apply(this.promise,[null,a])},cancel:function(a){if(this.rejected||this.resolved||this.canceled)throw new Error("DeepDeferred (cancel) has already been canceled !");this.canceled=this.promise.canceled=!0,this.promise.queue=[]},then:function(a,b){this.promise.then(s,e)},done:function(a){this.promise.done(a)},fail:function(a){this.promise.fail(a)}};var q=function(a){this.running=!0,a?(this.context=a.context,this.queue=a.queue):(this.context=deep.context,this.queue=[])};return q.prototype={rejected:!1,resolved:!1,canceled:!1,synch:!1,result:null,failure:null,done:function(a){var b=this,c=function(c,d){if(d||!a||c instanceof Error){b.running=!1,r.apply(b,[c,d]);return}var e=a(c);e&&(e instanceof o||e._isBRANCHES_)&&(e=deep.promise(e)),e&&typeof e.then=="function"?e.done(function(a){typeof a=="undefined"&&(a=c),b.running=!1,r.apply(b,[a instanceof Error?null:a,a instanceof Error?a:null])}).fail(function(a){b.running=!1,r.apply(b,[null,a])}):typeof e=="undefined"?(b.running=!1,r.apply(b,[c,d])):e instanceof Error?(b.running=!1,r.apply(b,[null,e])):(b.running=!1,r.apply(b,[e,null]))};return this.queue.push(c),(this.resolved||this.rejected)&&!this.running&&r.apply(this),b},fail:function(a){var b=this,c=function(c,d){if(d===null||typeof d=="undefined"||!a){b.running=!1,r.apply(b,[c,null]);return}var e=a(d);e&&(e instanceof o||e._isBRANCHES_)&&(e=deep.when(e)),e&&typeof e.then=="function"?e.done(function(a){b.running=!1,typeof a=="undefined"?r.apply(b,[null,d]):a instanceof Error?r.apply(b,[null,a]):r.apply(b,[a,null])}).fail(function(a){b.running=!1,r.apply(b,[null,a])}):typeof e=="undefined"?(b.running=!1,r.apply(b,[null,d])):e instanceof Error?(b.running=!1,r.apply(b,[null,e])):(b.running=!1,r.apply(b,[e,null]))};return this.queue.push(c),(this.resolved||this.rejected)&&!this.running&&r.apply(this),b},then:function(a,b){var c=this;return a&&this.done(a),b&&this.fail(b),(this.resolved||this.rejected)&&!this.running&&r.apply(this),c}},deep.promise=function(a){if(typeof a=="undefined"||a===null)return t(a);if(a._isBRANCHES_)return deep.all(a.branches);if(a instanceof o){var b=deep.Deferred();return a.deferred.fail(function(a){b.reject(a)}),a.done(function(a){a&&a.then?deep.when(a).fail(function(a){b.reject(a)}).done(function(a){console.log("deep.promise of DeepHandler : done : error ?",a instanceof Error),b.resolve(a)}):b.resolve(a)}),b.promise}return typeof a.promise=="function"?a.promise():a.promise?a.promise:typeof a.then=="function"?a:t(a)},deep.when=function(a){return a instanceof o?deep.promise(a):a&&typeof a.then=="function"?a:deep.promise(a)},deep.all=function(){var a=[];for(var b in arguments)a=a.concat(arguments[b]);if(a.length===0)return deep.when([]);var c=deep.Deferred(),d=a.length,e=0,f=-1,g=[],h=!1;return a.forEach(function(a){var b=f+1;if(!a||!a.then){if(a instanceof Error){h=!0,!c.rejected&&!c.resolved&&!c.canceled&&c.reject(a);return}g[b]=a,e++,e==d&&c.resolve(g)}else deep.when(a).then(function(a){if(a instanceof Error){!c.rejected&&!c.resolved&&!c.canceled&&c.reject(a);return}g[b]=a,e++,e==d&&c.resolve(g)},function(a){!c.rejected&&!c.resolved&&!c.canceled&&c.reject(a)});f++}),deep.promise(c)},f.when=deep.when,f.promise=deep.promise,f.all=deep.all,deep.Deferred=f.Deferred=function(){return new p},deep.DeepPromise=q,deep.sequence=function(a,b){if(!a||a.length===0)return b;var c=a.shift(),d=deep.Deferred(),e={},f=function(g){deep.when(g).then(function(g){if(a.length===0)return typeof g=="undefined"&&(g=b,b.length==1&&(g=b[0])),d.resolve(g),g;typeof g=="undefined"?g=b:g=[g],c=a.shift(),f(c.apply(e,g))},function(a){!d.rejected&&!d.resolved&&!d.canceled&&d.reject(a)})};return f(c.apply(e,b)),deep.promise(d)},deep.stores={},deep.handlers={},deep.handlers.decorations={},deep.store=function(a,b,c){c=c||{};var d=null;if(!b){if(!deep.stores[a])throw new Error("deep.store(name) : no store found with : ",a);return deep.stores[a]}return b instanceof Array?d=deep.stores[a]=deep.store.ArrayStore(b,c):b instanceof deep.store.DeepStore?d=deep.stores[a]=b.create(a,c):d=deep.stores[a]=deep.store.ObjectStore(b,c),d.name=a,d.options=c,d},deep.Handler.prototype.store=function(a){var b=this,c=null;if(typeof a=="string"){if(!deep.stores[a])throw new Error("no store found with.");c=deep.stores[a]}else c=a;var d=function(a,d){b._store=c,deep.chain.position(b,c.name),b.running=!1,k.apply(b,[a,d])};return deep.handlers.decorations.store(c,b),b},deep.handlers.decorations.store=function(a,b){return deep.utils.up({_store:deep.collider.replace(a),get:deep.compose.condition(typeof a.get=="function").createIfNecessary().replace(function(a,b){var c=this;if(a=="?"||!a)a="";var d=function(d,e){c._store.get(a,b).done(function(a){a instanceof Array?c._nodes=deep(a).nodes():c._nodes=[deep.Querier.createRootNode(a)],l(c,a,null)}).fail(function(a){l(c,null,a)})};return m.apply(this,[d]),c.range=deep.Handler.range,c}),post:deep.compose.condition(typeof a.post=="function").createIfNecessary().replace(function(a,b,c){var d=this,e=function(e,f){d._store.post(a||deep.chain.val(d),b,c).done(function(a){d._nodes=[deep.Querier.createRootNode(a)],l(d,a,null)}).fail(function(a){console.log("deeo.chain.store.post : post failed : ",a),l(d,null,a)})};return d.range=deep.Handler.range,m.apply(this,[e]),d}),put:deep.compose.condition(typeof a.put=="function").createIfNecessary().replace(function(a,b){var c=this,d=function(d,e){c._store.put(a||deep.chain.val(c),id,b).done(function(a){c._nodes=[deep.Querier.createRootNode(a)],l(c,a,null)}).fail(function(a){l(c,null,a)})};return c.range=deep.Handler.range,m.apply(this,[d]),c}),patch:deep.compose.condition(typeof a.patch=="function").createIfNecessary().replace(function(a,b,c){var d=this,e=function(e,f){d._store.patch(a||deep.chain.val(d),b,c).done(function(a){d._nodes=[deep.Querier.createRootNode(a)],l(d,a,null)}).fail(function(a){l(d,null,a)})};return d.range=deep.Handler.range,m.apply(this,[e]),d}),del:deep.compose.condition(typeof a.del=="function").createIfNecessary().replace(function(a,b){var c=this,d=function(d,e){var f=deep.chain.val(c);c._store.del(a||f.id,b).done(function(a){c._nodes=[deep.Querier.createRootNode(a)],l(c,a,null)}).fail(function(a){l(c,null,a)})};return c.range=deep.Handler.range,m.apply(this,[d]),c}),rpc:deep.compose.condition(typeof a.rpc=="function").createIfNecessary().replace(function(a,b,c,d){var e=this,f=function(f,g){e._store.rpc(a,b,c,d).done(function(a){e._nodes=[deep.Querier.createRootNode(a)],l(e,a,null)}).fail(function(a){l(e,null,a)})};return e.range=deep.Handler.range,m.apply(this,[f]),e}),range:deep.compose.condition(typeof a.range=="function").createIfNecessary().replace(function(a,b,c,d){var e=this,f=function(f,g){e._store.range(a,b,c,d).done(function(a){e._nodes=deep(a.results).nodes(),l(e,a,null)}).fail(function(a){l(e,null,a)})};return e.range=deep.Handler.range,m.apply(this,[f]),e}),bulk:deep.compose.condition(typeof a.bulk=="function").createIfNecessary().replace(function(a,b,c){var d=this,e=function(e,f){d._store.bulk(a,b,c).done(function(a){d._nodes=deep(a).nodes(),l(d,a,null)}).fail(function(a){l(d,null,a)})};return d.range=deep.Handler.range,m.apply(this,[e]),d})},b),b},deep.store.DeepStore=function(){},deep.store.DeepStore.prototype={},deep.store.ArrayStore=function(a,b){var c=new deep.store.DeepStore;b=b||{};var d={collection:a};return c.get=function(a){return a===""&&(a="?"),a.match(/^((\.?\/)?\?)|^(\?)/gi)?deep(d).query("collection/*"+a).store(this):deep(d).query("./collection/*?id="+a).store(this)},c.put=function(a,c){return c=c||a.id,b.schema?deep(a).validate(b.schema).fail(function(b){a=b}).root(d).replace("./collection/*?id="+c,a):deep(d).replace("./collection/*?id="+c,a),deep(a).store(this)},c.post=function(c,d){return d=d||c.id,d||(c.id=d=(new Date).valueOf()),b.schema?deep(c).validate(b.schema).done(function(b){a.push(c)}).fail(function(a){c=a}):a.push(c),deep(c).store(this)},c.del=function(a){return deep(d).remove("./collection/*?id="+a).store(this)},c.patch=function(a,b){return deep(d).query("./collection/*?id="+b).up(a).store(this)},c.range=function(a,b){return deep(d.collection).range(a,b).store(this)},c},deep.store.ObjectStore=function(a,b){var c=new deep.store.DeepStore;return b=b||{},c.get=function(b){return b[0]=="."||b[0]=="/"?deep(a).query(b).store(this):deep(a).query("./"+b).store(this)},c.put=function(b,c){return console.log("ObjectStore.put : ",b,c),deep(a).setByPath(c,b),deep(b).store(this)},c.post=function(c,d){return b.schema?deep(c).validate(b.schema).fail(function(a){c=a}).root(a).setByPath(d,c):deep(a).setByPath(d,c),deep(c).store(this)},c.del=function(b){var c=[];return b[0]=="."||b[0]=="/"?deep(a).remove(b).done(function(a){c=a}):deep(a).remove("./"+b).done(function(a){c=a}),deep(c).store(this)},c.patch=function(b,c){return c[0]=="."||c[0]=="/"?deep(a).query(c).up(b).store(this):deep(a).query("./"+c).up(b).store(this)},c},deep.get=function(a,b){if(typeof a!="string")return a;var c=deep.parseRequest(a);return c.store?c.queryThis?c.store.get(c,b):c.store.get(c.uri,b):c.protocole?new Error("no store found with : ",a):a},deep.getAll=function(a,b){var c=[];return a.forEach(function(a){if(typeof a!="string"){c.push(a);return}var d=deep.parseRequest(a);d.store?c.push(d.store.get(d.uri,b)):c.push(a)}),deep.all(c)},deep.parseRequest=function(a){var b=a.indexOf("::"),c=null,d=a,e=null;b>=0&&(c=a.substring(0,b),d=a.substring(b+2));var f=!1;if(a[0]=="#"||c=="first"||c=="last"||c=="this")e=deep.stores.queryThis,f=!0;else if(!c)for(var g in deep.stores){var h=deep.stores[g];if(!h.extensions)continue;for(var i=0;i<h.extensions.length;++i){var j=h.extensions[i];if(d.match(j)){e=h;break}}if(e)break}else e=deep.stores[c];var k={request:a,queryThis:f,store:e,protocole:c,uri:d};return k},deep.treat=function(a,b){return deep.applyTreatment.apply(a,[b||{}])},deep.applyTreatment=function(a){if(!this.how||this.condition===!1)return!1;if(typeof this.condition=="function"&&!this.condition.apply(this))return!1;a=a||this;var b=this,c=[];if(typeof this.what=="string"){var d=deep.interpret(this.what,a);c.push(deep.get(d,{root:a._deep_entry||a}))}else typeof this.what=="function"?c.push(this.what.apply(controller)):this.what&&c.push(this.what);if(typeof this.how=="string"){var e=deep.interpret(this.how,a);c.push(deep.get(e,{root:a._deep_entry||a}))}if(typeof this.where=="string"){var f=deep.interpret(this.where,a);c.push(deep.get(f,{root:a._deep_entry||a,acceptQueryThis:!0}))}return deep.all(c).done(function(c){var d=b.what?c.shift():a;d._isDQ_NODE_&&(d=d.value);var e=typeof b.how=="string"?c.shift():b.how,f=typeof b.where=="string"?c.shift():b.where,g="",h=b.nodes||null;try{g=e.apply({},[d]),f&&(h=f(g,h))}catch(i){return console.log("Error while treating : ",i),typeof b.fail=="function"?b.fail.apply(a,[i])||i:i}return typeof b.done=="function"?b.done.apply(a,[h,g,d])||[h,g,d]:h||g}).fail(function(c){return console.log("Error while treating : ",c),typeof b.fail=="function"?b.fail.apply(a,[c])||c:c})},deep.stores.queryThis={get:function(a,b){b=b||{};var c=b.root,d=b.basePath,e=a;typeof e=="string"&&(e=deep.parseRequest(e)),e.uri[0]=="#"&&(e.uri=e.uri.substring(1));var f=null;c._isDQ_NODE_?f=g.query(c,a,{keepCache:!1}):(d=d||"",d!==""&&e.uri.substring(0,3)=="../"&&(e.uri=(d[d.length-1]!="/"?d+"/":d)+e.uri),f=g.query(c,e.uri,{keepCache:!1}));if(f)switch(e.protocole){case"first":f=f[0]||null;break;case"last":f=f[f.length-1]||null}return f}},deep.stores.instance={get:function(b,c){var d=a(b);if(typeof d=="function"&&d.prototype)return deep(new d);throw console.log("DeepRequest : could not instanciate : "+JSON.stringify(info)),new Error("DeepRequest : could not instanciate : "+JSON.stringify(info))}},deep.stores.aspect={get:function(b,c){return deep(a(b)).then(function(a){return a.aspect},function(a){return a})}},deep.stores.js={get:function(b,c){return deep(a(b))}},deep}),define("testcases/app.js",["require","deep/deep"],function(a){console.flags={none:!1,"form-controller":!0},console.log("start app"),deep=a("deep/deep");var b=function(){console.log("app intialised")};return b}),require(["testcases/app.js","deep/deep"],function(a,b){console.flags={},a()}),define("testcases/main-for-build",function(){})